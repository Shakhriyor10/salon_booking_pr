{% extends 'base3.html' %}
{% load static %}
{% load form_tags %}

{% block hero %}
<section class="hero hero--salons py-5">
  <div class="container py-4 py-lg-5">
    <div class="row align-items-center g-5">
      <div class="col-lg-7">
        <span class="hero-badge"><i class="bi bi-magic"></i> Beauty &amp; Wellness</span>
        <h1 class="hero-title mt-3">Найдите салон, который подчеркнёт ваш стиль</h1>
        <p class="hero-subtitle mb-4">Выбирайте лучших мастеров города, сравнивайте рейтинги и бронируйте свободные окна в пару кликов. Мы собрали всё, что нужно для идеальной записи.</p>
        <div class="d-flex flex-wrap gap-3">
          <a class="btn btn-primary btn-lg" href="#filter"><i class="bi bi-calendar-plus me-2"></i>Записаться онлайн</a>
          <a class="btn btn-outline-light btn-lg" href="{% url 'service_booking' %}"><i class="bi bi-list-stars me-2"></i>Подобрать услуги</a>
        </div>
      </div>
      <div class="col-lg-5">
        <div class="hero-card p-4 p-lg-5">
          <p class="mb-4 text-white-50">GoBeauty помогает клиентам и салонам встречаться в нужный момент: свежие окна, подтверждения по SMS и персональные рекомендации.</p>
          <div class="hero-stats">
            <div class="hero-stats__item">
              <div class="hero-stats__value">{{ salons|length }}</div>
              <div class="hero-stats__label">Салонов рядом с вами</div>
            </div>
            <div class="hero-stats__item">
              <div class="hero-stats__value"><i class="bi bi-star-fill me-1"></i>4.8</div>
              <div class="hero-stats__label">Средний рейтинг салонов</div>
            </div>
            <div class="hero-stats__item">
              <div class="hero-stats__value">24/7</div>
              <div class="hero-stats__label">Онлайн-подтверждение</div>
            </div>
            <div class="hero-stats__item">
              <div class="hero-stats__value">3 шага</div>
              <div class="hero-stats__label">До записи мечты</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
{% endblock %}

{% block content %}
<div class="glass-card filter-card mb-5" id="filter">
  <div class="d-flex flex-column flex-lg-row justify-content-between align-items-start gap-3 mb-4">
    <div>
      <h2 class="h4 mb-2">Выберите салон под настроение</h2>
      <p class="text-muted mb-0">Отфильтруйте по типу, рейтингу или найдите нужную услугу — система предложит лучшие варианты поблизости.</p>
    </div>
    <div class="filter-tags">
      <span class="filter-tag"><i class="bi bi-stars"></i> Проверенные мастера</span>
      <span class="filter-tag"><i class="bi bi-clock-history"></i> Свободные окна</span>
      <span class="filter-tag"><i class="bi bi-heart"></i> Индивидуальный подход</span>
    </div>
  </div>

  <form id="filterForm" method="get">
    <div class="row g-3 g-lg-4 align-items-end">
      <div class="col-12 col-md-3">
        <label class="form-label text-muted">Тип салона</label>
        <select name="type" class="form-select">
          <option value="">Любой</option>
          <option value="male" {% if selected_type == "male" %}selected{% endif %}>Мужской</option>
          <option value="female" {% if selected_type == "female" %}selected{% endif %}>Женский</option>
          <option value="both" {% if selected_type == "both" %}selected{% endif %}>Универсальный</option>
        </select>
      </div>

      <div class="col-12 col-md-3">
        <label class="form-label text-muted">Рейтинг салона</label>
        <select name="rating" class="form-select">
          <option value="">Любой</option>
          {% for i in "54321" %}
            <option value="{{ i }}" {% if i == selected_rating %}selected{% endif %}>от {{ i }}★</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-12 col-md-4 position-relative">
        <label class="form-label text-muted">Поиск по названию или услуге</label>
        <input
          type="text"
          id="searchInput"
          name="search_value"
          placeholder="Например, окрашивание или GoBeauty Studio"
          autocomplete="off"
          value="{{ selected_service }}"
          class="form-control"
        >
        <input type="hidden" name="search_type" id="searchTypeInput" value="{{ request.GET.search_type }}">
        <ul
          id="suggestions"
          class="list-group suggestions-list position-absolute w-100"
          style="top: 100%; left: 0; z-index: 1050; max-height: 240px; overflow-y: auto; display: none;"
        ></ul>
      </div>

      <div class="col-12 col-md-2 d-grid">
        <button type="submit" class="btn btn-primary"><i class="bi bi-search me-2"></i>Найти</button>
      </div>
    </div>
  </form>
</div>

<div class="row g-4 stats-row">
  <div class="col-md-4">
    <div class="mini-stat h-100">
      <div class="mini-stat__value"><i class="bi bi-geo-alt me-2"></i>Ближайшие</div>
      <div class="mini-stat__label">Укажите ваш город — и мы покажем салон в нескольких минутах от вас.</div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="mini-stat h-100">
      <div class="mini-stat__value"><i class="bi bi-gift me-2"></i>Бонусы</div>
      <div class="mini-stat__label">Кэшбек и персональные предложения от партнёров каждую неделю.</div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="mini-stat h-100">
      <div class="mini-stat__value"><i class="bi bi-chat-dots me-2"></i>Поддержка</div>
      <div class="mini-stat__label">Наши стилисты готовы проконсультировать и помочь с выбором услуг.</div>
    </div>
  </div>
</div>

<h3 class="fw-semibold mt-5 mb-4 text-center text-md-start">Салоны</h3>
<div class="row g-4">
    {% for salon in salons %}
        <div class="col-md-6 col-xl-4">
            <div class="card salon-card h-100">
                {% if salon.photo %}
                    <img src="{{ salon.photo.url }}" class="card-img-top" alt="{{ salon.name }}">
                {% else %}
                    <img src="{% static 'img/default_salon.jpg' %}" class="card-img-top" alt="{{ salon.name }}">
                {% endif %}
                <div class="card-body d-flex flex-column">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <h5 class="card-title fw-semibold mb-0">{{ salon.name }}</h5>
                        {% if salon.get_type_display %}
                            <span class="badge text-uppercase">{{ salon.get_type_display }}</span>
                        {% endif %}
                    </div>
                    <div class="d-flex flex-wrap align-items-center gap-2 mb-3">
                        <div class="rating-stars">
                            {% for _ in salon.stars.full %}
                                <i class="text-warning bi bi-star-fill"></i>
                            {% endfor %}
                            {% if salon.stars.half %}
                                <i class="text-warning bi bi-star-half"></i>
                            {% endif %}
                            {% for _ in salon.stars.empty %}
                                <i class="text-muted bi bi-star"></i>
                            {% endfor %}
                        </div>
                        <span class="text-muted small">({{ salon.rating_value }}/5)</span>
                    </div>
                    <div class="d-flex flex-column gap-2 mb-3">
                        <div class="text-muted small d-flex align-items-center gap-2">
                            <i class="bi bi-geo-alt"></i>
                            <span>{{ salon.city.name }}{% if salon.address %}, {{ salon.address }}{% endif %}</span>
                        </div>
                        {% if salon.phone %}
                        <div class="text-muted small d-flex align-items-center gap-2">
                            <i class="bi bi-telephone"></i>
                            <span>{{ salon.phone }}</span>
                        </div>
                        {% endif %}
                    </div>
                    {% if salon.description %}
                        <p class="card-text line-clamp-2">{{ salon.description }}</p>
                    {% else %}
                        <p class="card-text line-clamp-2">Индивидуальные программы ухода и внимание к каждой детали.</p>
                    {% endif %}
                    <div class="mt-auto pt-3">
                        <a href="{% url 'salon_detail' salon.pk salon.slug %}" class="btn btn-primary w-100">Подробнее о салоне</a>
                    </div>
                </div>
            </div>
        </div>
    {% empty %}
        <div class="col-12">
            <div class="glass-card p-5 text-center">
                <h4 class="fw-semibold mb-2">Салоны не найдены</h4>
                <p class="text-muted mb-0">Попробуйте изменить параметры поиска или выберите другую услугу.</p>
            </div>
        </div>
    {% endfor %}
</div>
{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const input = document.getElementById("searchInput");
    const suggestionsBox = document.getElementById("suggestions");
    const searchTypeInput = document.getElementById("searchTypeInput");
    let suggestions = [];

    input.addEventListener("input", function () {
      const query = input.value.trim();
      searchTypeInput.value = "";

      if (query.length < 2) {
        suggestionsBox.style.display = "none";
        return;
      }

      fetch(`/autocomplete/?q=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(data => {
          suggestions = data;
          suggestionsBox.innerHTML = "";
          if (suggestions.length === 0) {
            suggestionsBox.style.display = "none";
            return;
          }

          suggestions.forEach(item => {
            const li = document.createElement("li");
            let label = item.label;
            if (item.type === "service" && item.gender) {
              label += ` (${item.gender})`;
            }
            li.textContent = label;
            li.classList.add("list-group-item", "list-group-item-action");
            li.addEventListener("click", () => {
              input.value = item.label;
              searchTypeInput.value = item.type;
              suggestionsBox.style.display = "none";
            });
            suggestionsBox.appendChild(li);
          });

          suggestionsBox.style.display = "block";
        });
    });

    document.addEventListener("click", function (e) {
      if (!suggestionsBox.contains(e.target) && e.target !== input) {
        suggestionsBox.style.display = "none";
      }
    });
  });
</script>
{% endblock %}
