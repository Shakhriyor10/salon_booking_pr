{% extends 'base3.html' %}
{% load static %}
{% load form_tags %}

{% block content %}
<style>
  :root {
    --salon-card-radius: 1.25rem;
    --salon-card-shadow: 0 18px 40px rgba(72, 107, 113, 0.18);
    --salon-card-shadow-hover: 0 24px 55px rgba(72, 107, 113, 0.26);
    --salon-accent: #486b71;
    --salon-accent-soft: rgba(72, 107, 113, 0.08);
  }

  .salon-grid {
    --bs-gutter-y: 2.5rem;
  }

  .salon-card {
    border-radius: var(--salon-card-radius);
    overflow: hidden;
    border: none;
    box-shadow: var(--salon-card-shadow);
    transition: transform 0.35s ease, box-shadow 0.35s ease;
    background: linear-gradient(180deg, #ffffff 0%, #f6fbfc 100%);
  }

  .salon-card:hover {
    transform: translateY(-8px);
    box-shadow: var(--salon-card-shadow-hover);
  }

  .salon-card__image-wrapper {
    position: relative;
    aspect-ratio: 16 / 11;
    background: linear-gradient(135deg, rgba(72, 107, 113, 0.08) 0%, rgba(72, 107, 113, 0.35) 100%);
  }

  .salon-card__image-wrapper img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }

  .salon-card__badge {
    position: absolute;
    bottom: 1rem;
    left: 1rem;
    padding: 0.35rem 0.85rem;
    font-size: 0.8rem;
    letter-spacing: 0.04em;
    text-transform: uppercase;
    background: rgba(255, 255, 255, 0.9);
    color: var(--salon-accent);
    border-radius: 999px;
    font-weight: 600;
    box-shadow: 0 10px 25px rgba(72, 107, 113, 0.18);
  }

  .salon-card__body {
    padding: 1.75rem 1.75rem 1.9rem;
  }

  .salon-card__title {
    font-size: 1.2rem;
    font-weight: 700;
    color: #233133;
    margin-bottom: 0.6rem;
  }

  .salon-card__rating {
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    padding: 0.5rem 0.85rem;
    border-radius: 999px;
    background: rgba(72, 107, 113, 0.08);
    color: #1c2a2c;
    font-weight: 600;
    margin-bottom: 1.1rem;
  }

  .salon-card__rating .bi {
    font-size: 1rem;
  }

  .salon-card__location {
    color: #5d6d70;
    font-size: 0.95rem;
    margin-bottom: 1.2rem;
  }

  .salon-card__button {
    background: var(--salon-accent);
    color: #fff;
    font-weight: 600;
    border-radius: 0.9rem;
    padding: 0.65rem 1.3rem;
    border: none;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }

  .salon-card__button:hover,
  .salon-card__button:focus {
    background: #3b585d;
    color: #fff;
    transform: translateY(-2px);
    box-shadow: 0 12px 25px rgba(72, 107, 113, 0.25);
  }

  @media (max-width: 575.98px) {
    .salon-card__body {
      padding: 1.5rem 1.4rem 1.75rem;
    }

    .salon-card__title {
      font-size: 1.05rem;
    }
  }
</style>
<!--<form method="get" class="row gy-2 gx-3 align-items-center mb-4">-->
<!--  &lt;!&ndash; Тип салона &ndash;&gt;-->
<!--<div class="col-sm-4 col-md-3">-->
<!--  <select name="type" class="form-select">-->
<!--    <option value="">Тип салона</option>-->
<!--    <option value="male" {% if selected_type == 'male' %}selected{% endif %}>Мужской</option>-->
<!--    <option value="female" {% if selected_type == 'female' %}selected{% endif %}>Женский</option>-->
<!--    <option value="both" {% if selected_type == 'both' %}selected{% endif %}>Обе</option>-->
<!--  </select>-->
<!--</div>-->

<!--  &lt;!&ndash; Рейтинг &ndash;&gt;-->
<!--  <div class="col-sm-4 col-md-3">-->
<!--    <select name="rating" class="form-select">-->
<!--      <option value="">Рейтинг</option>-->
<!--      <option value="4" {% if selected_rating == '4' %}selected{% endif %}>4+</option>-->
<!--      <option value="3.5" {% if selected_rating == '3.5' %}selected{% endif %}>3.5+</option>-->
<!--      <option value="3" {% if selected_rating == '3' %}selected{% endif %}>3+</option>-->
<!--    </select>-->
<!--  </div>-->

<!--  &lt;!&ndash; Поиск услуги &ndash;&gt;-->
<!--  <div class="col-sm-8 col-md-4 position-relative">-->
<!--    <input type="text" id="serviceSearch" name="service" class="form-control" placeholder="Поиск услуги..." autocomplete="off">-->
<!--    <ul id="suggestions" class="list-group position-absolute w-100 mt-1 shadow-sm" style="z-index: 1000;"></ul>-->
<!--  </div>-->

<!--  &lt;!&ndash; Кнопка поиска &ndash;&gt;-->
<!--  <div class="col-sm-4 col-md-2">-->
<!--    <button class="btn btn-primary w-100" type="submit">Поиск</button>-->
<!--  </div>-->
<!--</form>-->

<h3 class="text-center fw-semibold mt-4 mb-3">Поиск и фильтр</h3>
<form id="filterForm" method="get" class="mb-4">
  <div class="container-fluid">
    <div class="row gx-3 gy-2 align-items-center">

      <!-- Фильтр: Тип салона -->
      <div class="col-12 col-md-2">
          <select name="type" class="form-select">
  <option value="">Тип</option>
  <option value="male" {% if selected_type == "male" %}selected{% endif %}>Мужской</option>
  <option value="female" {% if selected_type == "female" %}selected{% endif %}>Женский</option>
  <option value="both" {% if selected_type == "both" %}selected{% endif %}>Оба</option>
</select>
      </div>

      <!-- Фильтр: Рейтинг -->
      <div class="col-12 col-md-2">
        <select name="rating" class="form-select">
          <option value="">Рейтинг</option>
          {% for i in "54321" %}
            <option value="{{ i }}" {% if i == selected_rating %}selected{% endif %}>от {{ i }}★</option>
          {% endfor %}
        </select>
      </div>

      <!-- Поиск -->
      <div class="col-12 col-md-6 position-relative">
        <input
          type="text"
          id="searchInput"
          name="search_value"
          placeholder="Поиск по салону или услуге"
          autocomplete="off"
          value="{{ selected_service }}"
          class="form-control"
        >
        <input type="hidden" name="search_type" id="searchTypeInput" value="{{ request.GET.search_type }}">

        <ul
          id="suggestions"
          class="list-group position-absolute w-100"
          style="top: 100%; left: 0; z-index: 1050; max-height: 200px; overflow-y: auto; display: none;"
        ></ul>
      </div>

      <!-- Кнопка -->
      <div class="col-12 col-md-2 d-grid">
        <button type="submit" class="btn" style="background-color: #486b71; color: #fff;">Найти</button>
      </div>

    </div>
  </div>
</form>
<h3 class="text-center fw-semibold mt-4 mb-3">Салоны</h3>
<div class="row row-cols-1 row-cols-md-2 row-cols-xl-3 salon-grid">
    {% for salon in salons %}
        <div class="col">
            <div class="salon-card h-100">
                <div class="salon-card__image-wrapper">
                    {% if salon.photo %}
                        <img src="{{ salon.photo.url }}" alt="{{ salon.name }}">
                    {% else %}
                        <img src="{% static 'img/default_salon.jpg' %}" alt="{{ salon.name }}">
                    {% endif %}
                    {% with salon.get_type_display as type_display %}
                      {% if type_display and type_display != 'Не указано' %}
                        <span class="salon-card__badge">{{ type_display }}</span>
                      {% endif %}
                    {% endwith %}
                </div>
                <div class="salon-card__body text-center d-flex flex-column align-items-center">
                    <h5 class="salon-card__title">{{ salon.name }}</h5>
                    <div class="salon-card__rating">
                        {% for _ in salon.stars.full %}
                            <i class="text-warning bi bi-star-fill"></i>
                        {% endfor %}
                        {% if salon.stars.half %}
                            <i class="text-warning bi bi-star-half"></i>
                        {% endif %}
                        {% for _ in salon.stars.empty %}
                            <i class="text-warning opacity-25 bi bi-star"></i>
                        {% endfor %}
                        <span>{{ salon.rating_value }}/5</span>
                    </div>
                    <p class="salon-card__location">
                        <i class="bi bi-geo-alt-fill me-1 text-warning"></i>{{ salon.city.name }}
                    </p>
                    <a href="{% url 'salon_detail' salon.pk salon.slug %}" class="btn salon-card__button mt-auto">Посмотреть</a>
                </div>
            </div>
        </div>
    {% empty %}
        <p>Салоны не найдены.</p>
    {% endfor %}
</div>
<!--<script>-->
<!--document.getElementById('serviceSearch').addEventListener('input', function () {-->
<!--    let query = this.value;-->
<!--    if (query.length < 2) return;-->

<!--    fetch(`/services/search/?q=${query}`)-->
<!--        .then(response => response.json())-->
<!--        .then(data => {-->
<!--            let suggestions = document.getElementById('suggestions');-->
<!--            suggestions.innerHTML = '';-->
<!--            data.forEach(item => {-->
<!--                let li = document.createElement('li');-->
<!--                li.className = 'list-group-item';-->
<!--                li.textContent = item;-->
<!--                li.onclick = function () {-->
<!--                    document.getElementById('serviceSearch').value = this.textContent;-->
<!--                    suggestions.innerHTML = '';-->
<!--                };-->
<!--                suggestions.appendChild(li);-->
<!--            });-->
<!--        });-->
<!--});-->
<!--</script>-->

<script>
document.addEventListener("DOMContentLoaded", function () {
  const input = document.getElementById("searchInput");
  const suggestionsBox = document.getElementById("suggestions");
  const searchTypeInput = document.getElementById("searchTypeInput");
  let suggestions = [];

  input.addEventListener("input", function () {
    const query = input.value.trim();
    searchTypeInput.value = ""; // сбрасываем search_type, если пользователь вводит вручную

    if (query.length < 2) {
      suggestionsBox.style.display = "none";
      return;
    }

    fetch(`/autocomplete/?q=${encodeURIComponent(query)}`)
      .then(response => response.json())
      .then(data => {
        suggestions = data;
        suggestionsBox.innerHTML = "";
        if (suggestions.length === 0) {
          suggestionsBox.style.display = "none";
          return;
        }

        suggestions.forEach(item => {
          const li = document.createElement("li");
          let label = item.label;
            if (item.type === "service" && item.gender) {
              label += ` (${item.gender})`;
            }
            li.textContent = label;
          li.classList.add("list-group-item", "list-group-item-action");
          li.addEventListener("click", () => {
            input.value = item.label;
            searchTypeInput.value = item.type;
            suggestionsBox.style.display = "none";
          });
          suggestionsBox.appendChild(li);
        });

        suggestionsBox.style.display = "block";
      });
  });

  // Скрыть подсказки при клике вне
  document.addEventListener("click", function (e) {
    if (!suggestionsBox.contains(e.target) && e.target !== input) {
      suggestionsBox.style.display = "none";
    }
  });
});
</script>

{% endblock %}