{% extends 'base3.html' %}
{% load static %}

{% block content %}
<div class="d-flex justify-content-center align-items-center" style="min-height: 100vh;">
    <div class="col-md-6 col-lg-5">
        <h3 class="mb-4 text-center">Добавить запись</h3>
        <form method="post" class="p-4 border rounded bg-light shadow-sm">
            {% csrf_token %}

            <div class="mb-3">
                <label class="form-label">Услуга:</label>
<select name="service_ids" id="serviceSelect" class="form-select" multiple required>
    {% for s in services %}
    <option value="{{ s.id }}">{{ s.name }}</option>
    {% endfor %}
</select>
<div class="form-text">Удерживайте Ctrl (или Cmd на Mac), чтобы выбрать несколько.</div>
            </div>

            <div class="mb-3">
                <label class="form-label">Мастер:</label>
                <select name="stylist_id" id="stylistSelect" class="form-select" required>
                    <option value="">Сначала выберите услугу</option>
                </select>
            </div>

            <div class="mb-3">
                <label class="form-label">Дата:</label>
                <input type="date" id="dateInput" name="date" class="form-control" required>
            </div>

            <div class="mb-3">
                <label class="form-label">Время:</label>
                <select name="start_time" id="timeSelect" class="form-select" required>
                    <option value="">Сначала выберите дату и мастера</option>
                </select>
            </div>

            <div class="mb-3">
                <label class="form-label">Имя клиента:</label>
                <input type="text" name="guest_name" class="form-control" required>
            </div>

            <div class="mb-3">
                <label class="form-label">Телефон:</label>
                <input type="text" name="guest_phone" class="form-control" required>
            </div>

            <button type="submit" class="btn w-100" style="background-color: #212529; color: #fff">➕ Добавить</button>
        </form>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const serviceSelect = document.getElementById("serviceSelect");
    const stylistSelect = document.getElementById("stylistSelect");
    const dateInput = document.getElementById("dateInput");
    const timeSelect = document.getElementById("timeSelect");

    // При выборе услуги загружаем мастеров
    serviceSelect.addEventListener("change", function () {
        const serviceId = this.value;

        // Очистим и покажем загрузку
        stylistSelect.innerHTML = '<option value="">Загрузка мастеров...</option>';
        timeSelect.innerHTML = '<option value="">Сначала выберите мастера и дату</option>';

        if (!serviceId) {
            stylistSelect.innerHTML = '<option value="">Сначала выберите услугу</option>';
            return;
        }

        fetch(`/get-stylists-by-service/?service_id=${serviceId}`)
            .then(res => res.json())
            .then(data => {
                stylistSelect.innerHTML = '<option value="">Выберите мастера</option>';
                data.stylists.forEach(s => {
                    stylistSelect.innerHTML += `<option value="${s.id}">${s.name}</option>`;
                });
            })
            .catch(err => {
                stylistSelect.innerHTML = '<option value="">Ошибка загрузки мастеров</option>';
                console.error(err);
            });
    });

    // Обновляем доступное время при изменении мастера или даты
    function updateAvailableTimes() {
        const stylistId = stylistSelect.value;
        const date = dateInput.value;
        const serviceId = serviceSelect.value;

        if (!stylistId || !date || !serviceId) {
            timeSelect.innerHTML = '<option value="">Сначала выберите мастера, дату и услугу</option>';
            return;
        }

        timeSelect.innerHTML = '<option value="">Загрузка времени...</option>';

        fetch(`/get-available-times/?stylist_id=${stylistId}&date=${date}&service_id=${serviceId}`)
            .then(res => res.json())
            .then(data => {
                timeSelect.innerHTML = '<option value="">Выберите время</option>';
                if (data.times.length === 0) {
                    timeSelect.innerHTML = '<option value="">Нет доступного времени</option>';
                } else {
                    data.times.forEach(t => {
                        const dt = `${date}T${t}`;
                        timeSelect.innerHTML += `<option value="${dt}">${t}</option>`;
                    });
                }
            })
            .catch(err => {
                timeSelect.innerHTML = '<option value="">Ошибка загрузки времени</option>';
                console.error(err);
            });
    }

    stylistSelect.addEventListener("change", updateAvailableTimes);
    dateInput.addEventListener("change", updateAvailableTimes);
});
</script>

{% endblock %}


