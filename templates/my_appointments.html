{% extends 'base3.html' %}
{% load static humanize %}

{% block content %}
<style>
  :root {
    --border: #e5e7eb;
    --muted: #6b7280;
    --surface: #ffffff;
    --bg: #f7f7f7;
    --accent: #111827;
  }

  .appointments-page {
    background: var(--bg);
    border-radius: 24px;
    padding: clamp(24px, 3vw, 40px);
    border: 1px solid var(--border);
  }

  .page-header {
    display: flex;
    justify-content: space-between;
    gap: 16px;
    align-items: center;
    flex-wrap: wrap;
    margin-bottom: 20px;
  }

  .page-header h1 {
    margin: 0;
    font-size: clamp(28px, 3vw, 34px);
    font-weight: 700;
  }

  .page-header p {
    margin: 4px 0 0;
    color: var(--muted);
  }

  .btn-pill {
    border-radius: 999px;
    padding: 10px 16px;
  }

  .compact-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 16px;
  }

  .stack {
    display: grid;
    gap: 12px;
  }

  .section-title {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin: 24px 0 12px;
    gap: 12px;
  }

  .section-title h3,
  .section-title h4 {
    margin: 0;
    font-weight: 700;
  }

  .profile-summary {
    display: grid;
    gap: 16px;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    align-items: start;
  }

  .profile-line {
    display: flex;
    align-items: center;
    gap: 10px;
    color: var(--muted);
  }

  .profile-initials {
    width: 56px;
    height: 56px;
    border-radius: 16px;
    background: #0f172a;
    color: #fff;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 1.3rem;
  }

  .favorite-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 12px;
  }

  .favorite-item {
    border-radius: 12px;
    border: 1px solid var(--border);
    padding: 12px;
    background: var(--surface);
  }

  .favorite-item header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 8px;
  }

  .favorite-rating {
    font-size: 0.9rem;
    color: #2563eb;
  }

  .appointment-card {
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 16px;
    background: var(--surface);
  }

  .appointment-header {
    display: flex;
    justify-content: space-between;
    gap: 12px;
    align-items: flex-start;
    flex-wrap: wrap;
  }

  .appointment-header h5 {
    margin: 0;
    font-weight: 700;
  }

  .status-chip {
    padding: 6px 12px;
    border-radius: 999px;
    font-size: 0.85rem;
    font-weight: 600;
    border: 1px solid var(--border);
  }

  .status-pending { color: #b45309; background: #fef3c7; }
  .status-confirmed { color: #065f46; background: #d1fae5; }
  .status-done { color: #1d4ed8; background: #dbeafe; }
  .status-canceled { color: #b91c1c; background: #fee2e2; }

  .info-row {
    display: flex;
    align-items: center;
    gap: 8px;
    color: var(--muted);
    font-size: 0.95rem;
  }

  .service-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin: 8px 0 0;
    padding: 0;
    list-style: none;
  }

  .service-tags li {
    padding: 6px 10px;
    border-radius: 10px;
    background: #eef2ff;
    color: #312e81;
    font-weight: 500;
    font-size: 0.9rem;
  }

  .payment-box {
    border: 1px dashed var(--border);
    border-radius: 10px;
    padding: 12px;
    margin-top: 12px;
    background: #f9fafb;
  }

  .payment-box .badge { border-radius: 8px; }

  .card-shell {
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 12px;
    margin-top: 12px;
    background: #111827;
    color: #f8fafc;
  }

  .card-shell small { color: #cbd5e1; }

  .copy-btn {
    background: #e5e7eb;
    border: none;
    border-radius: 10px;
    padding: 6px 10px;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    font-weight: 600;
  }

  .appointment-footer {
    display: flex;
    justify-content: space-between;
    gap: 12px;
    align-items: center;
    flex-wrap: wrap;
    margin-top: 12px;
    padding-top: 12px;
    border-top: 1px solid var(--border);
  }

  .empty-state {
    text-align: center;
    border: 1px dashed var(--border);
    border-radius: 14px;
    padding: 24px;
    background: var(--surface);
  }

  .aftercare-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 12px;
  }

  .aftercare-card {
    padding: 14px;
    border: 1px solid var(--border);
    border-radius: 12px;
    background: var(--surface);
  }

  .profile-form label {
    font-size: 0.85rem;
    color: var(--muted);
  }
</style>

<div class="appointments-page">
  <header class="page-header">
    <div>
      <h1>–ú–æ–∏ –∑–∞–ø–∏—Å–∏</h1>
      <p>–õ–∞–∫–æ–Ω–∏—á–Ω—ã–π —Å–ø–∏—Å–æ–∫ –≤–∞—à–∏—Ö –≤–∏–∑–∏—Ç–æ–≤ –∏ –æ–ø–ª–∞—Ç—ã</p>
    </div>
    <a href="{% url 'home' %}" class="btn btn-dark btn-pill">–ó–∞–ø–∏—Å–∞—Ç—å—Å—è –µ—â—ë</a>
  </header>

  <div class="profile-summary">
    <div class="compact-card stack">
      <div class="profile-line">
        <div class="profile-initials">{% firstof request.user.first_name|slice:":1" request.user.username|slice:":1" %}</div>
        <div>
          <div class="fw-semibold">{{ request.user.get_full_name|default:request.user.username }}</div>
          <div class="text-muted">–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å</div>
        </div>
      </div>

      {% if upcoming_appointment %}
        <div class="compact-card">
          <div class="text-uppercase text-muted small mb-1">–ë–ª–∏–∂–∞–π—à–∞—è –∑–∞–ø–∏—Å—å</div>
          <div class="fw-semibold">{{ upcoming_appointment.start_time|date:"d E" }} ‚Ä¢ {{ upcoming_appointment.start_time|date:"H:i" }}</div>
          {% with first_service=upcoming_appointment.services.all|first %}
            <div class="info-row">
              <i class="bi bi-geo-alt"></i>
              {% if first_service and first_service.stylist_service and first_service.stylist_service.salon_service %}
                {{ first_service.stylist_service.salon_service.salon.name }}
              {% else %}
                {{ upcoming_appointment.stylist.salon.name|default:"–°–∞–ª–æ–Ω —É—Ç–æ—á–Ω—è–µ—Ç—Å—è" }}
              {% endif %}
            </div>
          {% endwith %}
        </div>
      {% endif %}
    </div>

    <div class="compact-card">
      <div class="d-flex justify-content-between align-items-center">
        <div class="fw-semibold">–ö–æ–Ω—Ç–∞–∫—Ç—ã</div>
        <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#profileForm" aria-expanded="false" aria-controls="profileForm">
          –û–±–Ω–æ–≤–∏—Ç—å
        </button>
      </div>
      <div class="mt-2 text-muted">–¢–µ–ª–µ—Ñ–æ–Ω: {{ request.user.profile.phone|default:"–î–æ–±–∞–≤—å—Ç–µ –Ω–æ–º–µ—Ä" }}</div>

      <div class="collapse mt-3" id="profileForm">
        <form method="post" novalidate class="stack">
          {% csrf_token %}
          <input type="hidden" name="profile_form" value="1">
          {% if profile_form.non_field_errors %}
            <div class="invalid-feedback d-block mb-2">
              {{ profile_form.non_field_errors|join:", " }}
            </div>
          {% endif %}
          <div class="row g-3">
            <div class="col-sm-6">
              <label class="form-label">{{ profile_form.first_name.label }}</label>
              {{ profile_form.first_name }}
              {% if profile_form.first_name.errors %}
                <div class="invalid-feedback d-block">{{ profile_form.first_name.errors|join:", " }}</div>
              {% endif %}
            </div>
            <div class="col-sm-6">
              <label class="form-label">{{ profile_form.last_name.label }}</label>
              {{ profile_form.last_name }}
              {% if profile_form.last_name.errors %}
                <div class="invalid-feedback d-block">{{ profile_form.last_name.errors|join:", " }}</div>
              {% endif %}
            </div>
            <div class="col-12">
              <label class="form-label">{{ profile_form.phone.label }}</label>
              {{ profile_form.phone }}
              {% if profile_form.phone.errors %}
                <div class="invalid-feedback d-block">{{ profile_form.phone.errors|join:", " }}</div>
              {% endif %}
            </div>
          </div>
          <div class="d-grid">
            <button type="submit" class="btn btn-dark">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <section class="favorite-salons">
    <div class="section-title">
      <h3>–ò–∑–±—Ä–∞–Ω–Ω—ã–µ —Å–∞–ª–æ–Ω—ã</h3>
      <a href="{% url 'home' %}" class="btn btn-outline-secondary btn-sm">–ù–∞–π—Ç–∏ –Ω–æ–≤—ã–π —Å–∞–ª–æ–Ω</a>
    </div>

    {% if favorite_salons %}
      <div class="favorite-grid">
        {% for salon in favorite_salons %}
          <div class="favorite-item">
            <header>
              <div class="fw-semibold">{{ salon.name }}</div>
              <div class="favorite-rating"><i class="bi bi-star-fill"></i> {{ salon.rating_value|default:"0.0" }}/5</div>
            </header>
            <div class="info-row mt-2"><i class="bi bi-geo-alt"></i>{{ salon.city.name }}</div>
            <a href="{% url 'salon_detail' salon.pk salon.slug %}" class="btn btn-outline-dark btn-sm mt-3">–û—Ç–∫—Ä—ã—Ç—å</a>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="empty-state">
        <div class="mb-2">‚ù§Ô∏è</div>
        <div class="mb-2">–î–æ–±–∞–≤–ª—è–π—Ç–µ —Å–∞–ª–æ–Ω—ã –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ, —á—Ç–æ–±—ã –æ–Ω–∏ –ø–æ—è–≤–∏–ª–∏—Å—å –∑–¥–µ—Å—å.</div>
        <a href="{% url 'home' %}" class="btn btn-dark btn-sm">–ü–µ—Ä–µ–π—Ç–∏ –∫ –∫–∞—Ç–∞–ª–æ–≥—É</a>
      </div>
    {% endif %}
  </section>

  {% if appointments %}
    <div class="stack">
      {% for appointment in appointments %}
        <article class="appointment-card">
          <header class="appointment-header">
            <div>
              <h5>{{ appointment.stylist.user.get_full_name|default:appointment.stylist.user.username }}</h5>
              {% with first_service=appointment.services.all|first %}
                <div class="info-row">
                  <i class="bi bi-building"></i>
                  {% if first_service and first_service.stylist_service and first_service.stylist_service.salon_service %}
                    {{ first_service.stylist_service.salon_service.salon.name }}
                  {% else %}
                    {% if appointment.stylist.salon %}
                      {{ appointment.stylist.salon.name }}
                    {% else %}
                      –°–∞–ª–æ–Ω —É—Ç–æ—á–Ω—è–µ—Ç—Å—è
                    {% endif %}
                  {% endif %}
                </div>
              {% endwith %}
            </div>
            <span class="status-chip {% if appointment.status == 'P' %}status-pending{% elif appointment.status == 'C' %}status-confirmed{% elif appointment.status == 'D' %}status-done{% elif appointment.status == 'X' %}status-canceled{% endif %}">
              {% if appointment.status == 'P' %}–û–∂–∏–¥–∞–µ—Ç{% elif appointment.status == 'C' %}–ü—Ä–∏–Ω—è—Ç–æ{% elif appointment.status == 'D' %}–í—ã–ø–æ–ª–Ω–µ–Ω–æ{% elif appointment.status == 'X' %}–û—Ç–º–µ–Ω–µ–Ω–æ{% endif %}
            </span>
          </header>

          <div class="mt-2">
            <div class="text-muted small mb-1">–£—Å–ª—É–≥–∏</div>
            <ul class="service-tags">
              {% for service in appointment.services.all %}
                {% if service.stylist_service and service.stylist_service.salon_service %}
                  <li>{{ service.stylist_service.salon_service.service.name }}</li>
                {% else %}
                  <li class="bg-light text-muted">–£—Å–ª—É–≥–∞ —É—Ç–æ—á–Ω—è–µ—Ç—Å—è</li>
                {% endif %}
              {% empty %}
                <li class="bg-light text-muted">–£—Å–ª—É–≥–∏ –Ω–µ —É–∫–∞–∑–∞–Ω—ã</li>
              {% endfor %}
            </ul>
          </div>

          <div class="payment-box">
            <div class="d-flex flex-wrap gap-2 align-items-center">
              <span class="badge bg-dark text-uppercase">{{ appointment.get_payment_method_display }}</span>
              <span class="badge {% if appointment.payment_status == 'paid' %}bg-success{% elif appointment.payment_status == 'awaiting_payment' %}bg-warning text-dark{% elif appointment.payment_status == 'awaiting_confirmation' %}bg-info text-dark{% elif appointment.payment_status == 'refund_requested' %}bg-danger{% else %}bg-secondary{% endif %}">{{ appointment.get_payment_status_display }}</span>
            </div>

            {% if appointment.can_change_payment_method %}
              <form method="post" class="mt-2">
                {% csrf_token %}
                <input type="hidden" name="payment_action" value="change_method">
                <input type="hidden" name="appointment_id" value="{{ appointment.id }}">
                <div class="d-flex flex-column flex-md-row gap-2 align-items-start">
                  <select id="payment-method-{{ appointment.id }}" name="payment_method" class="form-select form-select-sm">
                    {% for value, label in appointment.payment_method_choices %}
                      <option value="{{ value }}" {% if value == appointment.payment_method %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                  </select>
                  <button type="submit" class="btn btn-outline-dark btn-sm">–û–±–Ω–æ–≤–∏—Ç—å</button>
                </div>
              </form>
            {% elif appointment.payment_receipt %}
              <p class="small text-muted mb-0 mt-2">–ü–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ —á–µ–∫–∞ –∏–∑–º–µ–Ω–∏—Ç—å —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã –Ω–µ–ª—å–∑—è.</p>
            {% endif %}
          </div>

          {% if appointment.payment_method == 'card' %}
            {% if appointment.show_card_details %}
              <div class="card-shell">
                {% with card_number=appointment.active_payment_card.card_number|default_if_none:''|cut:' '|cut:'-' %}
                  <div class="d-flex justify-content-between flex-wrap gap-2">
                    <div>
                      <small class="text-uppercase">{{ appointment.active_payment_card.get_card_type_display|default:"–ö–∞—Ä—Ç–∞" }}</small>
                      <div class="fw-semibold mt-1">{{ card_number|default:"‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢" }}</div>
                    </div>
                    <button type="button" class="copy-btn" data-copy="{{ card_number }}" data-copy-label="–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å" data-copy-success="–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!">
                      <i class="bi bi-clipboard"></i>
                      <span class="copy-btn__text">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</span>
                    </button>
                  </div>
                {% endwith %}

                <div class="d-flex justify-content-between flex-wrap gap-2 align-items-center mt-3">
                  <div>
                    <small class="text-uppercase">–í–ª–∞–¥–µ–ª–µ—Ü</small>
                    <div class="fw-semibold">{{ appointment.active_payment_card.cardholder_name|default:"‚Äî" }}</div>
                  </div>
                  <div>
                    <small class="text-uppercase">–°—É–º–º–∞</small>
                    <div class="fw-semibold">{{ appointment.get_total_price|floatformat:0|intcomma }} —Å—É–º</div>
                  </div>
                  <button type="button" class="copy-btn" data-copy="{{ appointment.get_total_price|floatformat:0|intcomma }} —Å—É–º" data-copy-label="–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å" data-copy-success="–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!">
                    <i class="bi bi-clipboard"></i>
                    <span class="copy-btn__text">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—É–º–º—É</span>
                  </button>
                </div>
              </div>
            {% elif not appointment.active_payment_card and appointment.status != 'X' %}
              <div class="alert alert-warning mt-2 mb-0">
                –†–µ–∫–≤–∏–∑–∏—Ç—ã —Å–∞–ª–æ–Ω–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã. –£—Ç–æ—á–Ω–∏—Ç–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ–ø–ª–∞—Ç—ã —É –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.
              </div>
            {% endif %}

            {% if appointment.can_upload_receipt %}
              <form method="post" enctype="multipart/form-data" class="mt-3">
                {% csrf_token %}
                <input type="hidden" name="payment_action" value="upload_receipt">
                <input type="hidden" name="appointment_id" value="{{ appointment.id }}">
                <div class="row g-2 align-items-end">
                  <div class="col-md-8">
                    <label class="form-label small text-muted">–ó–∞–≥—Ä—É–∑–∏—Ç—å —á–µ–∫</label>
                    <input type="file" name="receipt" class="form-control form-control-sm" accept="image/*" required>
                  </div>
                  <div class="col-md-4 d-grid d-md-flex justify-content-md-end">
                    <button type="submit" class="btn btn-success btn-sm">–û—Ç–ø—Ä–∞–≤–∏—Ç—å —á–µ–∫</button>
                  </div>
                </div>
              </form>
            {% elif appointment.payment_receipt %}
              <div class="mt-3 d-flex flex-wrap gap-2 align-items-center">
                <a href="{{ appointment.payment_receipt.url }}" target="_blank" class="btn btn-outline-secondary btn-sm">–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π —á–µ–∫</a>
                {% if appointment.payment_status == 'awaiting_confirmation' %}
                  <span class="text-muted small">–ß–µ–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –∏ –æ–∂–∏–¥–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –º–∞—Å—Ç–µ—Ä–æ–º.</span>
                {% endif %}
              </div>
            {% endif %}

            {% if appointment.status == 'X' and appointment.payment_method == 'card' %}
              {% if appointment.refund_card_number %}
                <div class="alert alert-secondary mt-3 mb-0">
                  <div class="small text-uppercase text-muted">–ö–∞—Ä—Ç–∞ –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞</div>
                  <div class="fw-semibold mt-1">{{ appointment.refund_cardholder_name }}</div>
                  <div class="text-muted">
                    {% for value, label in card_type_choices %}
                      {% if value == appointment.refund_card_type %}
                        {{ label }}
                      {% endif %}
                    {% endfor %}
                    ‚Ä¢ <code>{{ appointment.refund_card_number }}</code>
                  </div>
                </div>
              {% endif %}

              {% if appointment.can_edit_refund_details %}
                <form method="post" class="mt-3">
                  {% csrf_token %}
                  <input type="hidden" name="payment_action" value="provide_refund">
                  <input type="hidden" name="appointment_id" value="{{ appointment.id }}">
                  <div class="row g-2">
                    <div class="col-md-4">
                      <label class="form-label small text-muted">–¢–∏–ø –∫–∞—Ä—Ç—ã</label>
                      <select name="refund_card_type" class="form-select form-select-sm" required>
                        {% for value, label in card_type_choices %}
                          <option value="{{ value }}" {% if value == appointment.refund_card_type %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                      </select>
                    </div>
                    <div class="col-md-4">
                      <label class="form-label small text-muted">–ò–º—è –≤–ª–∞–¥–µ–ª—å—Ü–∞</label>
                      <input type="text" name="refund_cardholder_name" class="form-control form-control-sm" value="{{ appointment.refund_cardholder_name|default_if_none:'' }}" required>
                    </div>
                    <div class="col-md-4">
                      <label class="form-label small text-muted">–ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã</label>
                      <input type="text" name="refund_card_number" class="form-control form-control-sm" value="{{ appointment.refund_card_number|default_if_none:'' }}" required>
                    </div>
                    <div class="col-12 d-flex justify-content-between align-items-center">
                      <div class="text-muted small">
                        {% if appointment.refund_card_number %}
                          –ú–æ–∂–Ω–æ –æ–±–Ω–æ–≤–ª—è—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –≤–æ–∑–≤—Ä–∞—Ç–∞.
                        {% else %}
                          –£–∫–∞–∂–∏—Ç–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã –∫–∞—Ä—Ç—ã, —á—Ç–æ–±—ã –º—ã –º–æ–≥–ª–∏ –≤–µ—Ä–Ω—É—Ç—å –æ–ø–ª–∞—Ç—É.
                        {% endif %}
                      </div>
                      <button type="submit" class="btn btn-outline-primary btn-sm">
                        {% if appointment.refund_card_number %}
                          –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞
                        {% else %}
                          –û—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞
                        {% endif %}
                      </button>
                    </div>
                  </div>
                </form>
              {% elif not appointment.refund_card_number %}
                <div class="alert alert-warning mt-3 mb-0">
                  –î–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ —Å—Ä–µ–¥—Å—Ç–≤ —É–∫–∞–∂–∏—Ç–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã –∫–∞—Ä—Ç—ã. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É, –µ—Å–ª–∏ –Ω—É–∂–Ω–∞ –ø–æ–º–æ—â—å.
                </div>
              {% endif %}

              {% if appointment.refund_receipt %}
                <div class="mt-3 d-flex flex-wrap gap-2 align-items-center">
                  <a href="{{ appointment.refund_receipt.url }}" target="_blank" class="btn btn-outline-secondary btn-sm">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —á–µ–∫ –≤–æ–∑–≤—Ä–∞—Ç–∞</a>
                </div>
              {% endif %}
            {% endif %}
          {% endif %}

          <footer class="appointment-footer">
            <div class="text-muted">
              <i class="bi bi-clock"></i>
              {{ appointment.start_time|date:"d E" }} ‚Ä¢ {{ appointment.start_time|date:"H:i" }}
              <span class="ms-2">{{ appointment.start_time|date:"l"|capfirst }}</span>
            </div>
            <div>
              {% if appointment.status == 'P' or appointment.status == 'C' %}
              <form method="post" action="{% url 'cancel_appointment' appointment.id %}" class="d-inline">
                {% csrf_token %}
                <button type="submit" class="btn btn-outline-danger btn-sm" onclick="return confirm('–¢–æ—á–Ω–æ –æ—Ç–º–µ–Ω–∏—Ç—å –∑–∞–ø–∏—Å—å?')">
                  –û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–ø–∏—Å—å
                </button>
              </form>
              {% else %}
              <span class="text-muted">–î–µ–π—Å—Ç–≤–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã</span>
              {% endif %}
            </div>
          </footer>
        </article>
      {% endfor %}
    </div>
  {% else %}
    <div class="empty-state">
      <div class="emoji">üí´</div>
      <h3 class="fw-bold mb-3">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π</h3>
      <p>–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—É—é –∑–∞–ø–∏—Å—å, —á—Ç–æ–±—ã —Å–æ—Å—Ç–∞–≤–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω —É—Ö–æ–¥–∞ –∏ –ø–æ–ª—É—á–∞—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ —Å–∞–º—ã—Ö –≤–∞–∂–Ω—ã—Ö –ø—Ä–æ—Ü–µ–¥—É—Ä–∞—Ö.</p>
      <a href="{% url 'home' %}" class="btn btn-dark btn-lg rounded-pill px-5">–ù–∞–π—Ç–∏ —É—Å–ª—É–≥—É</a>
      <div class="tips">
        <span><i class="bi bi-lightning-charge"></i> –ü–æ–¥—Å–∫–∞–∑–∫–∞: –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å, —á—Ç–æ–±—ã –º–∞—Å—Ç–µ—Ä–∞ –∑–Ω–∞–ª–∏, –∫–∞–∫ —Å –≤–∞–º–∏ —Å–≤—è–∑–∞—Ç—å—Å—è.</span>
      </div>
    </div>
  {% endif %}

  <section class="aftercare">
    <h4 class="fw-bold mb-3">–°–æ–≤–µ—Ç—ã –¥–ª—è —Å–ø–æ–∫–æ–π–Ω—ã—Ö –≤–∏–∑–∏—Ç–æ–≤</h4>
    <div class="aftercare-grid">
      <div class="aftercare-card">
        <div class="icon">üóìÔ∏è</div>
        <h6>–ü–ª–∞–Ω–∏—Ä—É–π—Ç–µ –∑–∞—Ä–∞–Ω–µ–µ</h6>
        <p>–í—ã–±–∏—Ä–∞–π—Ç–µ —É–¥–æ–±–Ω—ã–µ –æ–∫–Ω–∞, –ø–æ–∫–∞ –æ–Ω–∏ —Å–≤–æ–±–æ–¥–Ω—ã.</p>
      </div>
      <div class="aftercare-card">
        <div class="icon">üí¨</div>
        <h6>–î–µ–ª–∏—Ç–µ—Å—å –æ–∂–∏–¥–∞–Ω–∏—è–º–∏</h6>
        <p>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –ø–æ–º–æ–≥–∞—é—Ç –º–∞—Å—Ç–µ—Ä—É –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å—Å—è.</p>
      </div>
      <div class="aftercare-card">
        <div class="icon">üéÅ</div>
        <h6>–°–æ—Ö—Ä–∞–Ω—è–π—Ç–µ –ª—é–±–∏–º—ã—Ö</h6>
        <p>–í–æ–∑–≤—Ä–∞—â–∞–π—Ç–µ—Å—å –∫ –º–∞—Å—Ç–µ—Ä–∞–º, –∫–æ—Ç–æ—Ä—ã–µ –≤–∞–º –Ω—Ä–∞–≤—è—Ç—Å—è.</p>
      </div>
    </div>
  </section>
</div>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const copyButtons = document.querySelectorAll('.copy-btn[data-copy]');

    async function copyValue(value) {
      if (!value) {
        return false;
      }

      if (navigator.clipboard && navigator.clipboard.writeText) {
        try {
          await navigator.clipboard.writeText(value);
          return true;
        } catch (error) {
          // fallback will run below
        }
      }

      const textarea = document.createElement('textarea');
      textarea.value = value;
      textarea.setAttribute('readonly', '');
      textarea.style.position = 'fixed';
      textarea.style.opacity = '0';
      document.body.appendChild(textarea);
      textarea.focus();
      textarea.select();
      textarea.setSelectionRange(0, textarea.value.length);

      let copied = false;
      try {
        copied = document.execCommand('copy');
      } catch (error) {
        copied = false;
      }

      document.body.removeChild(textarea);
      return copied;
    }

    copyButtons.forEach(function (button) {
      const labelEl = button.querySelector('.copy-btn__text');

      if (labelEl && !labelEl.dataset.defaultText) {
        labelEl.dataset.defaultText = labelEl.textContent.trim();
      }

      if (!button.dataset.copyLabel && labelEl && labelEl.dataset.defaultText) {
        button.dataset.copyLabel = labelEl.dataset.defaultText;
      }

      button.addEventListener('click', async function () {
        const value = button.getAttribute('data-copy');
        const successText = button.dataset.copySuccess || '–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
        const errorText = button.dataset.copyError || '–ù–µ —É–¥–∞–ª–æ—Å—å';
        const defaultLabel = button.dataset.copyLabel || (labelEl ? labelEl.dataset.defaultText || '' : '');

        try {
          const wasCopied = await copyValue(value);
          if (!wasCopied) {
            throw new Error('copy-failed');
          }

          button.classList.add('copied');
          if (labelEl) {
            labelEl.textContent = successText;
          }

          setTimeout(function () {
            button.classList.remove('copied');
            if (labelEl) {
              labelEl.textContent = defaultLabel;
            }
          }, 2000);
        } catch (error) {
          if (labelEl) {
            labelEl.textContent = errorText;
          }

          setTimeout(function () {
            button.classList.remove('copied');
            if (labelEl) {
              labelEl.textContent = defaultLabel;
            }
          }, 2000);
        }
      });
    });
  });
</script>
{% endblock %}
