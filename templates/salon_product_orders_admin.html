{% extends 'base3.html' %}
{% load humanize %}

{% block content %}
<div class="container py-4">
  <h2 class="mb-4">Заказы товаров салона</h2>
  {% if orders %}
    <div class="table-responsive">
      <table class="table align-middle">
        <thead>
          <tr>
            <th>ID</th>
            <th>Клиент</th>
            <th>Контакты</th>
            <th>Адрес</th>
            <th>Сумма</th>
            <th>Оплата</th>
            <th>Статус</th>
            <th class="text-end">Действия</th>
          </tr>
        </thead>
        <tbody>
          {% for order in orders %}
          <tr>
            <td>#{{ order.id }}<div class="text-muted small">{{ order.created_at|date:"d.m.Y H:i" }}</div></td>
            <td>
              {% if order.user %}
                {{ order.user.get_full_name|default:order.user.username }}
              {% else %}
                Гость
              {% endif %}
            </td>
            <td>
              <div>{{ order.contact_name|default:"—" }}</div>
              <div class="text-muted small">{{ order.contact_phone|default:"" }}</div>
            </td>
            <td>
              {% if order.is_pickup %}
                <span class="badge bg-secondary">Самовывоз</span>
              {% else %}
                {{ order.address|default:"—" }}
              {% endif %}
            </td>
            <td>{{ order.total_amount|intcomma }} сум</td>
            <td>{{ order.get_payment_method_display }}</td>
            <td>{{ order.get_status_display }}</td>
            <td class="text-end">
              <form method="post" class="d-inline-flex gap-2 align-items-center">
                {% csrf_token %}
                <input type="hidden" name="order_id" value="{{ order.id }}">
                <select name="status" class="form-select form-select-sm">
                  {% for value,label in status_choices %}
                    <option value="{{ value }}" {% if value == order.status %}selected{% endif %}>{{ label }}</option>
                  {% endfor %}
                </select>
                <button type="submit" class="btn btn-primary btn-sm">Сохранить</button>
              </form>
              <details class="mt-2">
                <summary class="small text-muted">Товары</summary>
                <ul class="mb-0 small">
                  {% for item in order.items.all %}
                    <li>{{ item.product_name }} — {{ item.quantity }} шт. ({{ item.unit_price|intcomma }} сум)</li>
                  {% endfor %}
                </ul>
              </details>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <p class="text-muted">Заказов пока нет.</p>
  {% endif %}
</div>
{% endblock %}