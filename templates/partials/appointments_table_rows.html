{% load form_tags humanize %}
{% with show_stylist=show_stylist_column|default:True %}
{% with total_columns=show_stylist|yesno:'7,6' %}
{% for date, appointments_on_date in grouped_appointments.items %}
  <div class="appointments-day card" data-day-block data-date="{{ date|date:'Y-m-d' }}">
    <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-3 py-3 px-4">
      <div class="d-flex align-items-center gap-3">
        <div class="date-icon d-flex align-items-center justify-content-center">
          <i class="bi bi-calendar-event"></i>
        </div>
        <div>
          <div class="text-muted text-uppercase small fw-semibold">Дата</div>
          <div class="fs-5 fw-bold">{{ date }}</div>
        </div>
      </div>
      <span class="badge rounded-pill bg-dark-subtle text-dark fw-semibold px-3 py-2">
        <span data-day-count>{{ appointments_on_date|length }}</span> записей
      </span>
    </div>
    <div class="table-responsive">
      <table class="table table-modern align-middle mb-0">
        <thead>
          <tr>
            <th scope="col">Клиент</th>
            <th scope="col">Услуга</th>
            {% if show_stylist %}
              <th scope="col">Мастер</th>
            {% endif %}
            <th scope="col">Время</th>
            <th scope="col">Статус</th>
            <th scope="col">Цена</th>
            <th scope="col">Действия</th>
          </tr>
        </thead>
        <tbody>
          {% for a in appointments_on_date %}
            <tr class="appointment-row" data-appointment-row="true" data-status="{{ a.status }}" data-appointment-id="{{ a.id }}" data-date="{{ a.start_time|date:'Y-m-d' }}">
              <td data-label="Клиент">
  {% if a.customer %}
    <div class="client-name">{{ a.customer.first_name|default:a.customer.username }}</div>

    {% if is_salon_admin or stylist.show_client_phone %}
      {% if a.customer.profile.phone %}
        <div class="client-contact"><i class="bi bi-telephone"></i> {{ a.customer.profile.phone }}</div>
      {% else %}
        <div class="client-contact text-muted"><i class="bi bi-telephone"></i> Телефон не указан</div>
      {% endif %}
    {% else %}
      <div class="client-contact text-muted"><i class="bi bi-shield-lock"></i> Номер скрыт</div>
    {% endif %}

  {% else %}
    <div class="client-name">{{ a.guest_name }}</div>

    {% if is_salon_admin or stylist.show_client_phone %}
      {% if a.guest_phone %}
        <div class="client-contact"><i class="bi bi-telephone"></i> {{ a.guest_phone }}</div>
      {% else %}
        <div class="client-contact text-muted"><i class="bi bi-telephone"></i> Телефон не указан</div>
      {% endif %}
    {% else %}
      <div class="client-contact text-muted"><i class="bi bi-shield-lock"></i> Номер скрыт</div>
    {% endif %}

  {% endif %}
</td>
              <td data-label="Услуга">
                {% for ap_service in a.services.all %}
                  <span class="service-pill">{{ ap_service.stylist_service.salon_service.service.name }}</span>
                {% empty %}
                  <span class="text-muted">—</span>
                {% endfor %}
              </td>
              {% if show_stylist %}
                <td data-label="Мастер">
                  <div class="fw-semibold">{{ a.stylist.user }}</div>
                </td>
              {% endif %}
              <td data-label="Время">
                <div class="fw-semibold">{{ a.start_time|date:"H:i" }}</div>
              </td>
              <td data-label="Статус">
                <span class="badge status-badge {{ a.status|status_badge_class }}">{{ a.get_status_display }}</span>
              </td>
              <td data-label="Цена">
                <div class="price-value">{{ a.services.all|sum_prices|floatformat:0|intcomma }} сум</div>
              </td>
              <td data-label="Действия">
                <div class="d-flex flex-wrap gap-2">
                  {% if a.status == 'P' %}
  <button type="button" class="btn btn-success btn-sm btn-action" data-appointment-action="confirm" data-appointment-id="{{ a.id }}">
    <i class="bi bi-check2-circle"></i>
    <span>Принять</span>
  </button>

  {% if is_salon_admin or stylist.allow_cancel_appointment %}
    <button type="button" class="btn btn-outline-danger btn-sm btn-action" data-appointment-action="cancel" data-appointment-id="{{ a.id }}">
      <i class="bi bi-x-circle"></i>
      <span>Отменить</span>
    </button>
  {% endif %}

{% elif a.status == 'C' %}
  <button type="button" class="btn btn-primary btn-sm btn-action" data-appointment-action="done" data-appointment-id="{{ a.id }}">
    <i class="bi bi-scissors"></i>
    <span>Выполнено</span>
  </button>

  {% if is_salon_admin or stylist.allow_cancel_appointment %}
    <button type="button" class="btn btn-outline-danger btn-sm btn-action" data-appointment-action="cancel" data-appointment-id="{{ a.id }}">
      <i class="bi bi-x-circle"></i>
      <span>Отменить</span>
    </button>
  {% endif %}
{% endif %}
                  {% if a.payment_method == 'card' %}
                    <span class="badge bg-light text-dark">{{ a.get_payment_status_display }}</span>
                    {% if a.payment_receipt %}
                      <a href="{{ a.payment_receipt.url }}" target="_blank" class="btn btn-outline-secondary btn-sm">
                        <i class="bi bi-receipt"></i>
                        <span>Чек</span>
                      </a>
                    {% endif %}
                    {% if a.payment_status == 'awaiting_confirmation' %}
                      <form method="post" action="{% url 'appointment_payment_action' a.id %}">
                        <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
                        <input type="hidden" name="payment_action" value="confirm">
                        <button type="submit" class="btn btn-success btn-sm">
                          <i class="bi bi-shield-check"></i>
                          <span>Подтвердить оплату</span>
                        </button>
                      </form>
                    {% elif a.payment_status == 'refund_requested' %}
                      {% if a.refund_card_number and a.refund_cardholder_name and a.refund_card_type %}
                        <form
                          method="post"
                          action="{% url 'appointment_payment_action' a.id %}"
                          enctype="multipart/form-data"
                          class="d-flex flex-column gap-2"
                        >
                          <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
                          <input type="hidden" name="payment_action" value="mark_refunded">
                          <div class="d-flex flex-wrap gap-2 align-items-center">
                            <input type="file" name="refund_receipt" class="form-control form-control-sm" accept="image/*">
                            <button type="submit" class="btn btn-outline-success btn-sm">
                              <i class="bi bi-arrow-repeat"></i>
                              <span>Возврат выполнен</span>
                            </button>
                          </div>
                          <span class="text-muted small">Можно приложить чек возврата, чтобы клиент увидел подтверждение.</span>
                        </form>
                      {% else %}
                        <div class="alert alert-warning py-2 px-3 mb-0 small">
                          Клиент ещё не указал реквизиты карты для возврата. Дождитесь данных, прежде чем завершать перевод.
                        </div>
                      {% endif %}
                    {% endif %}
                    {% if a.payment_status != 'refunded' and a.refund_card_number %}
                      <div class="refund-card">
                        <div class="refund-card__header">
                          <span class="refund-card__label">Карта клиента для возврата</span>
                          <span class="refund-card__brand">
                            {{ a.refund_card_type|card_type_label|default:"Карта" }}
                          </span>
                        </div>
                        {% with groups=a.refund_card_number|card_groups %}
                          <div class="refund-card__number">
                            <div class="refund-card__digits">
                              {% if groups %}
                                {% for group in groups %}
                                  <span>{{ group }}</span>
                                {% endfor %}
                              {% else %}
                                <span>{{ a.refund_card_number }}</span>
                              {% endif %}
                            </div>
                            <button
                              type="button"
                              class="copy-btn"
                              data-copy="{% if groups %}{{ groups|join:' ' }}{% else %}{{ a.refund_card_number }}{% endif %}"
                              data-copy-label="Копировать"
                              data-copy-success="Скопировано!"
                            >
                              <i class="bi bi-clipboard"></i>
                              <span class="copy-btn__text">Копировать</span>
                            </button>
                          </div>
                        {% endwith %}
                        <div class="refund-card__holder">
                          <span>Владелец карты</span>
                          <strong>{{ a.refund_cardholder_name|default:"—" }}</strong>
                        </div>
                        {% with refund_total=a.services.all|sum_prices %}
                          <div class="refund-card__footer">
                            <div class="refund-card__amount">
                              <div>
                                <span class="refund-card__helper">Сумма возврата</span>
                                <strong>{{ refund_total|default:0|intcomma }} сум</strong>
                              </div>
                              <button
                                type="button"
                                class="copy-btn"
                                data-copy="{{ refund_total|default:0|intcomma }} сум"
                                data-copy-label="Копировать"
                                data-copy-success="Скопировано!"
                              >
                                <i class="bi bi-clipboard"></i>
                                <span class="copy-btn__text">Копировать</span>
                              </button>
                            </div>
                          </div>
                        {% endwith %}
                      </div>
                    {% endif %}
                    {% if a.refund_receipt %}
                      <a href="{{ a.refund_receipt.url }}" target="_blank" class="btn btn-outline-secondary btn-sm">
                        <i class="bi bi-receipt"></i>
                        <span>Чек возврата</span>
                      </a>
                    {% endif %}
                  {% endif %}
                </div>
              </td>
            </tr>
          {% empty %}
            <tr class="no-appointments-row">
              <td colspan="{{ total_columns }}" class="text-center text-muted py-4">Нет записей</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
{% empty %}
  <div class="empty-dashboard-state text-center" data-empty-dashboard-state>
    <div class="icon-wrap mb-3">
      <i class="bi bi-stars"></i>
    </div>
    <div class="fs-4 fw-semibold mb-2">Записей пока нет</div>
    <p class="text-muted mb-0">Создайте первую запись вручную или подождите, пока клиенты оставят заявки через сайт.</p>
</div>
{% endfor %}
{% endwith %}
{% endwith %}

<div class="modal fade" id="cancelModal" tabindex="-1" aria-labelledby="cancelModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header border-0 pb-0">
        <div>
          <div class="text-muted text-uppercase small fw-semibold">Подтверждение действия</div>
          <h5 class="modal-title fw-bold mt-1" id="cancelModalLabel">Отменить запись?</h5>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
      </div>
      <div class="modal-body pt-3">
        <p class="mb-0">Мы уведомим клиента и мастера о том, что запись отменена. Вы уверены, что хотите продолжить?</p>
      </div>
      <div class="modal-footer border-0 pt-0">
        <button type="button" class="btn btn-light" data-bs-dismiss="modal">Оставить как есть</button>
        <button type="button" class="btn btn-danger" id="confirmCancelBtn">Да, отменить</button>
      </div>
    </div>
  </div>
</div>