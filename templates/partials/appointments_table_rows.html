{% load form_tags %}
{% for date, appointments_on_date in grouped_appointments.items %}
  <h5 class="mt-4">{{ date }}</h5>

  <div class="table-responsive">
    <table class="table table-striped table-bordered align-middle">
      <thead class="table-dark">
        <tr>
          <th scope="col">Клиент</th>
          <th scope="col">Услуга</th>
          <th scope="col">Мастер</th>
          <th scope="col">Время</th>
          <th scope="col">Статус</th>
          <th scope="col">Цена</th>
          <th scope="col">Действия</th>
        </tr>
      </thead>
      <tbody>
        {% for a in appointments_on_date %}
          <tr>
            <td>
              {% if a.customer %}
              {{ a.customer.first_name|default:a.customer.username }}
              {% if a.customer.profile.phone %}
              ({{ a.customer.profile.phone }})
              {% endif %}
              {% else %}
              {{ a.guest_name }} ({{ a.guest_phone }})
              {% endif %}
            </td>
            <td>
              {% for ap_service in a.services.all %}
              {{ ap_service.stylist_service.salon_service.service.name }}{% if not forloop.last %}, {% endif %}
              {% endfor %}
            </td>
            <td>{{ a.stylist.user }}</td>
            <td>{{ a.start_time|date:"H:i" }}</td>
            <td>{{ a.get_status_display }}</td>
            <td>
  {{ a.services.all|sum_prices }} сум
</td>
            <td>
              {% if a.status == 'P' %}
              <button onclick="submitAction({{ a.id }}, 'confirm')" class="btn btn-success btn-sm">✅ Принять</button>
              <button onclick="submitAction({{ a.id }}, 'cancel')" class="btn btn-danger btn-sm">❌ Отменить</button>
              {% elif a.status == 'C' %}
              <button onclick="submitAction({{ a.id }}, 'done')" class="btn btn-primary btn-sm">✂️ Выполнено</button>
              <button onclick="submitAction({{ a.id }}, 'cancel')" class="btn btn-danger btn-sm">❌ Отменить</button>
              {% endif %}
            </td>
          </tr>
        {% empty %}
          <tr><td colspan="6">Нет записей</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

{% endfor %}

<div class="modal fade" id="cancelModal" tabindex="-1" aria-labelledby="cancelModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="cancelModalLabel">Подтверждение</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        Вы действительно хотите отменить запись?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Нет</button>
        <button type="button" class="btn btn-danger" id="confirmCancelBtn">Да, отменить</button>
      </div>
    </div>
  </div>
</div>


