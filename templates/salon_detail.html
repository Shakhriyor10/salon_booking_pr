{% extends 'base3.html' %}
{% load static %}
{% load form_tags %}
{% load widget_tweaks %}
{% load custom_filters %}

{% block content %}
<style>
  .add-to-cart {
  background-color: #486b71;
  color: #fff;
  border: 1px solid #486b71;
  padding: 8px 16px;
  border-radius: 6px;
  transition: background-color 0.3s ease, border-color 0.3s ease;
}

.add-to-cart:hover {
  background-color: #36565a;
  border-color: #36565a;
  color: #fff;
}

.add-to-cart.added {
  background-color: #28a745;
  border-color: #28a745;
  color: #fff;
}

.add-to-cart.added:hover {
  background-color: #218838;
  border-color: #218838;
}
  .floating-cart {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 999;
    transition: opacity 0.3s ease, transform 0.3s ease;
  }

  .floating-cart.show {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
  }

  .floating-cart.d-none {
    opacity: 0;
    pointer-events: none;
    transform: translateX(-50%) translateY(20px);
  }

  .btn-custom {
    background-color: #486b71;
    color: #fff;
    border: none;
    padding: 12px 24px;
    font-weight: 500;
    border-radius: 8px;
  }

  .btn-custom:hover {
    background-color: #36565a;
  }
</style>
{% if categories %}
  <h3 class="text-center fw-semibold mt-4 mb-3">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</h3>
  <div class="row">
    {% for category in categories %}
      <div class="col-md-4 mb-4">
        <div class="card h-100 shadow-sm">
          {% if category.photo %}
            <img src="{{ category.photo.url }}" class="card-img-top" alt="{{ category.photo.url }}">
          {% endif %}
          <div class="card-body d-flex flex-column">
            <h5 class="card-title text-center">{{ category.name }}</h5>
            <a href="{% url 'category_services' category.id %}?salon={{ salon.id }}" class="btn mt-auto"
               style="background-color: #486b71; color: #fff">–û—Ç–∫—Ä—ã—Ç—å</a>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>
{% endif %}


{% if uncategorized_services %}
  <h3 class="text-center fw-semibold mt-4 mb-3">–í—Å–µ —É—Å–ª—É–≥–∏</h3>
  <div class="row">
    {% for salon_service in uncategorized_services %}
      <div class="col-md-4 mb-4">
        <div class="card h-100 shadow-sm">
          {% if salon_service.service.photo %}
            <img src="{{ salon_service.service.photo.url }}" class="card-img-top" alt="{{ salon_service.service.name }}">
          {% endif %}
          <div class="card-body d-flex flex-column">
            <h5 class="card-title text-center">{{ salon_service.service.name }}</h5>
<button
              class="btn btn-outline-primary mt-auto add-to-cart"
              data-service-id="{{ salon_service.service.id }}">
              ‚ûï –î–æ–±–∞–≤–∏—Ç—å —É—Å–ª—É–≥—É
            </button>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>
{% endif %}

{% if stylists %}
  <h3 class="text-center fw-semibold mt-4 mb-3">–ù–∞—à–∏ –º–∞—Å—Ç–µ—Ä–∞</h3>
  <div class="row">
    {% for stylist in stylists %}
      <div class="col-md-4 col-sm-6 mb-4">
        <div class="card h-100 shadow-sm">
          <div class="card-body d-flex flex-column">
            {% with name=stylist.user.get_full_name|default:stylist.user.username %}
            <div class="d-flex justify-content-center mb-3">
              {% if stylist.avatar %}
                <img src="{{ stylist.avatar.url }}" alt="{{ name }}"
                     class="rounded-circle"
                     style="width: 120px; height: 120px; object-fit: cover; border: 3px solid #dee2e6;">
              {% else %}
                <div class="rounded-circle d-flex align-items-center justify-content-center"
                     style="width: 120px; height: 120px; background-color: #f1f3f5; border: 3px solid #dee2e6;">
                  <span class="fw-semibold" style="font-size: 42px; color: #486b71;">
                    {{ name|slice:":1"|upper }}
                  </span>
                </div>
              {% endif %}
            </div>

            <h5 class="card-title text-center">{{ name }}</h5>

            <div class="text-center mb-3">
              {% if stylist.level %}
                {% if stylist.level.name == "–¢–æ–ø –ë–∞—Ä–±–µ—Ä" %}
                  <span class="badge bg-warning text-dark">‚òÖ {{ stylist.level.name }}</span>
                {% elif stylist.level.name == "–°—Ç–∞—Ä—à–∏–π –ë–∞—Ä–±–µ—Ä" %}
                  <span class="badge bg-success">üíà {{ stylist.level.name }}</span>
                {% elif stylist.level.name == "–ë–∞—Ä–±–µ—Ä" %}
                  <span class="badge bg-secondary">‚úÇÔ∏è {{ stylist.level.name }}</span>
                {% else %}
                  <span class="badge bg-light text-dark">{{ stylist.level.name }}</span>
                {% endif %}
              {% else %}
                <span class="badge bg-light text-dark">–ë–∞—Ä–±–µ—Ä</span>
              {% endif %}
            </div>

            {% with services_list=stylist.salon_services_for_display %}
              {% if services_list %}
                <ul class="list-unstyled small text-muted flex-grow-1">
                  {% for ss in services_list|slice:":3" %}
                    <li>‚Ä¢ {{ ss.salon_service.service.name }}</li>
                  {% endfor %}
                  {% with total=services_list|length %}
                    {% if total > 3 %}
                      <li class="text-muted">–∏ –µ—â—ë {{ total|add:"-3" }} —É—Å–ª—É–≥</li>
                    {% endif %}
                  {% endwith %}
                </ul>
              {% else %}
                <p class="text-muted small text-center flex-grow-1">–£—Å–ª—É–≥–∏ –º–∞—Å—Ç–µ—Ä–∞ –ø–æ–∫–∞ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã.</p>
              {% endif %}
            {% endwith %}

            <a href="{% url 'service_booking' %}?salon={{ salon.id }}&stylist={{ stylist.id }}"
               class="btn mt-auto"
               style="background-color: #486b71; color: #fff;">
              –í—ã–±—Ä–∞—Ç—å –º–∞—Å—Ç–µ—Ä–∞
            </a>
            {% endwith %}
          </div>
        </div>
      </div>
    {% endfor %}
  </div>
{% endif %}

<h3 class="text-center fw-semibold mt-4 mb-3">–ö–æ–Ω—Ç–∞–∫—Ç—ã</h3>

  <div class="row">
    <!-- –ö–∞—Ä—Ç–∞ -->
    <div class="col-md-8 mb-4">
      <div class="ratio ratio-4x3 rounded shadow">
        {% if salon.latitude and salon.longitude %}
        {% with lat=salon.latitude|stringformat:"f"|cut:","|add:"." %}
        {% with lon=salon.longitude|stringformat:"f"|cut:","|add:"." %}
        <iframe
                src="https://yandex.ru/map-widget/v1/?ll={{ lon }},{{ lat }}&z=15&pt={{ lon }},{{ lat }},pm2rdm"
                width="100%"
                height="400"
                frameborder="0"
                allowfullscreen>
        </iframe>
        {% endwith %}
        {% endwith %}
        {% else %}
        <p>–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –Ω–µ —É–∫–∞–∑–∞–Ω—ã.</p>
        {% endif %}
      </div>
    </div>

    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
    <div class="col-md-4">
      <h2>{{ salon.name }}</h2>
      {% if salon.photo %}
        <img src="{{ salon.photo.url }}" alt="{{ salon.name }}" class="img-fluid rounded mb-3">
      {% endif %}
      <p><strong>–ê–¥—Ä–µ—Å:</strong> {{ salon.address }}</p>
      <p><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> {{ salon.phone }}</p>
      <p><strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong> {{ salon.description }}</p>
    </div>
  </div>



  <!-- –ù–∞–∑–≤–∞–Ω–∏–µ —Å–∞–ª–æ–Ω–∞ -->
  <div class="card mb-4 shadow-sm">
    <div class="card-body">
      <h2 class="card-title">{{ object.name }}</h2>

      <!-- –°—Ä–µ–¥–Ω—è—è –æ—Ü–µ–Ω–∫–∞ -->
      <div class="d-flex align-items-center mt-3 mb-4">
        <div class="me-2 text-warning fs-5">
          {% for _ in stars.full %}
            <i class="bi bi-star-fill"></i>
          {% endfor %}
          {% if stars.half %}
            <i class="bi bi-star-half"></i>
          {% endif %}
          {% for _ in stars.empty %}
            <i class="bi bi-star"></i>
          {% endfor %}
        </div>
        <span class="text-muted">({{ average_rating|floatformat:1 }}/5)</span>
      </div>

      <!-- –ë–ª–æ–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç–∑—ã–≤–∞ -->
      <div class="card mb-5">
        <div class="card-header bg-light">
          <h5 class="mb-0">–û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤</h5>
        </div>
        <div class="card-body">
          <form method="post">
            {% csrf_token %}

            <!-- –†–µ–π—Ç–∏–Ω–≥ –∑–≤—ë–∑–¥–∞–º–∏ -->
            <div class="mb-3">
              <label class="form-label d-block">–í–∞—à–∞ –æ—Ü–µ–Ω–∫–∞:</label>
              <div id="star-rating" class="text-warning fs-4">
                {% for i in "12345" %}
                  <i class="bi bi-star" data-value="{{ forloop.counter }}"></i>
                {% endfor %}
              </div>
              <input type="hidden" name="rating" id="rating-value" required>
            </div>

            <!-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π -->
            <div class="mb-3">
              <label for="id_comment" class="form-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
              <textarea name="comment" id="id_comment" rows="3" class="form-control" placeholder="–í–∞—à –æ—Ç–∑—ã–≤ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)"></textarea>
            </div>

            <button type="submit" class="btn" style="background-color: #486b71; color: #fff">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
          </form>
        </div>
      </div>

      <!-- –°–ø–∏—Å–æ–∫ –æ—Ç–∑—ã–≤–æ–≤ -->
      <div class="card">
        <div class="card-header bg-light">
          <h5 class="mb-0">–û—Ç–∑—ã–≤—ã –∫–ª–∏–µ–Ω—Ç–æ–≤</h5>
        </div>
        <div class="card-body">
          {% if reviews %}
            {% for review in reviews %}
              <div class="border-bottom pb-3 mb-3">
                <div class="d-flex justify-content-between mb-1">
                  <strong>{{ review.user.username }}</strong>
                  <small class="text-muted">{{ review.created_at|date:"d M Y, H:i" }}</small>
                </div>
                <div class="text-warning mb-1">
                  {% for i in "12345"|make_list %}
                    {% if forloop.counter <= review.rating %}
                      <i class="bi bi-star-fill"></i>
                    {% else %}
                      <i class="bi bi-star"></i>
                    {% endif %}
                  {% endfor %}
                </div>
                {% if review.comment %}
                  <p class="mb-0">{{ review.comment }}</p>
                {% endif %}
              </div>
            {% endfor %}
          {% else %}
            <p class="text-muted">–û—Ç–∑—ã–≤–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç. –ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º!</p>
          {% endif %}
        </div>
      </div>

    </div>
  </div>

<div id="floating-cart-button" class="floating-cart d-none d-flex align-items-center gap-2">
  <button id="go-to-booking" class="btn btn-custom" data-salon-id="{{ salon.id }}" disabled>
    –ü–µ—Ä–µ–π—Ç–∏ –∫ –∑–∞–ø–∏—Å–∏ (<span id="cart-count">0</span>)
  </button>
  <button id="clear-cart" class="btn btn-outline-danger btn-sm" title="–û—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É">&times;</button>
</div>


  <!-- –£—Å–ª—É–≥–∏ -->
<script>
  const stars = document.querySelectorAll('#star-rating i');
  const ratingInput = document.getElementById('rating-value');
  const form = document.querySelector('form');

  // –ü—Ä–∏ –∫–ª–∏–∫–µ –ø–æ –∑–≤–µ–∑–¥–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –∏ –º–µ–Ω—è–µ–º –∫–ª–∞—Å—Å—ã
  stars.forEach((star, idx) => {
    star.addEventListener('click', () => {
      ratingInput.value = idx + 1;

      stars.forEach((s, i) => {
        s.classList.toggle('bi-star-fill', i <= idx);
        s.classList.toggle('bi-star', i > idx);
      });
    });
  });

  // –ù–µ –¥–∞—ë–º –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–æ—Ä–º—É, –µ—Å–ª–∏ –∑–≤–µ–∑–¥–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω–∞
  form.addEventListener('submit', (e) => {
    if (!ratingInput.value) {
      e.preventDefault();
      alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–≤—ë–∑–¥.');
    }
  });
</script>
<script>
  function getCart() {
    const cart = localStorage.getItem("cart");
    return cart ? JSON.parse(cart) : [];
  }

  function saveCart(cart) {
    localStorage.setItem("cart", JSON.stringify(cart));
  }

function updateCartUI() {
  const cart = getCart();
  const count = cart.length;
  document.getElementById("cart-count").textContent = count;
  const bookingButton = document.getElementById("go-to-booking");
  bookingButton.disabled = count === 0;

  const floatingCart = document.getElementById("floating-cart-button");
  if (count > 0) {
    floatingCart.classList.remove("d-none");
    floatingCart.classList.add("show");
  } else {
    floatingCart.classList.remove("show");
    floatingCart.classList.add("d-none");
  }

  document.querySelectorAll(".add-to-cart").forEach(btn => {
    const id = parseInt(btn.dataset.serviceId);
    if (cart.includes(id)) {
      btn.textContent = "‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ (–Ω–∞–∂–º–∏ —á—Ç–æ–±—ã —É–¥–∞–ª–∏—Ç—å)";
      btn.classList.add("added");
    } else {
      btn.textContent = "‚ûï –î–æ–±–∞–≤–∏—Ç—å —É—Å–ª—É–≥—É";
      btn.classList.remove("added");
    }
  });
}


  document.addEventListener("DOMContentLoaded", () => {
    updateCartUI();

    // –ö–Ω–æ–ø–∫–∏ "–î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É"
    document.querySelectorAll(".add-to-cart").forEach(button => {
      button.addEventListener("click", () => {
        const serviceId = parseInt(button.dataset.serviceId);
        let cart = getCart();

        if (cart.includes(serviceId)) {
          cart = cart.filter(id => id !== serviceId);
        } else {
          cart.push(serviceId);
        }

        saveCart(cart);
        updateCartUI();
      });
    });

    // –ö–Ω–æ–ø–∫–∞ "–ü–µ—Ä–µ–π—Ç–∏ –∫ –∑–∞–ø–∏—Å–∏"
    document.getElementById("go-to-booking").addEventListener("click", (event) => {
  const cart = getCart();
  if (cart.length === 0) return;

  const salonId = event.target.dataset.salonId;

  if (!salonId) {
    alert("–û—à–∏–±–∫–∞: salon ID –Ω–µ –Ω–∞–π–¥–µ–Ω");
    return;
  }

  const params = new URLSearchParams();
  params.append("salon", salonId);
  cart.forEach(id => params.append("services", id));

  window.location.href = `/booking/?${params.toString()}`;
});
  });
</script>
<script>
  const currentSalonId = "{{ salon.id }}";  // –¢–µ–∫—É—â–∏–π ID —Å–∞–ª–æ–Ω–∞
  const savedSalonId = localStorage.getItem("currentSalonId");

  // –ü—Ä–æ–≤–µ—Ä–∫–∞: –µ—Å–ª–∏ —Å–∞–ª–æ–Ω —Å–º–µ–Ω–∏–ª—Å—è ‚Äî —É–¥–∞–ª—è–µ–º –∫–æ—Ä–∑–∏–Ω—É
  if (savedSalonId && savedSalonId !== currentSalonId) {
    localStorage.removeItem("cart");
    localStorage.removeItem("cartTimestamp");  // –£–¥–∞–ª–∏–º –∏ –º–µ—Ç–∫—É –≤—Ä–µ–º–µ–Ω–∏
  }

  // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–π ID —Å–∞–ª–æ–Ω–∞
  localStorage.setItem("currentSalonId", currentSalonId);

  // –û—á–∏—Å—Ç–∫–∞ –∫–æ—Ä–∑–∏–Ω—ã –ø–æ —Ç–∞–π–º–µ—Ä—É 15 –º–∏–Ω—É—Ç
  const now = Date.now();
  const cartTimestamp = localStorage.getItem("cartTimestamp");

  if (cartTimestamp && now - parseInt(cartTimestamp) > 15 * 60 * 1000) {
    // –ï—Å–ª–∏ –ø—Ä–æ—à–ª–æ –±–æ–ª—å—à–µ 15 –º–∏–Ω—É—Ç ‚Äî –æ—á–∏—â–∞–µ–º –∫–æ—Ä–∑–∏–Ω—É
    localStorage.removeItem("cart");
    localStorage.removeItem("cartTimestamp");
  }

  // –ü—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —É—Å–ª—É–≥–∏ ‚Äî –æ–±–Ω–æ–≤–∏–º —Ç–∞–π–º–µ—Ä
  document.querySelectorAll(".add-to-cart").forEach(button => {
    button.addEventListener("click", () => {
      localStorage.setItem("cartTimestamp", Date.now().toString());
    });
  });


document.getElementById("clear-cart").addEventListener("click", function () {
  // –û—á–∏—Å—Ç–∫–∞ localStorage
  localStorage.removeItem("cart");
  localStorage.removeItem("cartTimestamp");

  // –°–±—Ä–æ—Å–∏—Ç—å —Å—á—ë—Ç—á–∏–∫
  document.getElementById("cart-count").textContent = "0";

  // –°–∫—Ä—ã—Ç—å –∫–Ω–æ–ø–∫—É –∫–æ—Ä–∑–∏–Ω—ã
  document.getElementById("floating-cart-button").classList.add("d-none");

  // –°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –∫–Ω–æ–ø–∫–∏ "–î–æ–±–∞–≤–ª–µ–Ω–æ" –æ–±—Ä–∞—Ç–Ω–æ –≤ "–î–æ–±–∞–≤–∏—Ç—å —É—Å–ª—É–≥—É"
  document.querySelectorAll(".add-to-cart").forEach(button => {
    // –ü–æ–ª–Ω—ã–π —Å–±—Ä–æ—Å –∫–ª–∞—Å—Å–æ–≤ –¥–æ –Ω–∞—á–∞–ª—å–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
    button.className = "btn btn-outline-primary mt-auto add-to-cart";
    button.textContent = "‚ûï –î–æ–±–∞–≤–∏—Ç—å —É—Å–ª—É–≥—É";
  });
});


</script>
{% endblock %}