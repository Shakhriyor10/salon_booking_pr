{% extends 'base3.html' %}
{% load humanize %}

{% block content %}
<div class="container py-4 py-md-5">
  <style>
    .order-card {
      border: 1px solid #e9ecef;
      border-radius: 18px;
      transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
      background: linear-gradient(145deg, #ffffff 0%, #f9fafb 100%);
    }

    .order-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 32px rgba(0, 0, 0, 0.08);
      border-color: #dfe3e8;
    }

    .order-pill {
      width: 48px;
      height: 48px;
      border-radius: 14px;
      background: linear-gradient(135deg, #141414, #2b2b2b);
      color: #fff;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      letter-spacing: 0.02em;
      box-shadow: 0 8px 20px rgba(20, 20, 20, 0.2);
    }

    .status-badge {
      border-radius: 999px;
      padding: 0.45rem 0.8rem;
      font-weight: 600;
      letter-spacing: 0.02em;
    }

    .status-created { background: #f1f3f5; color: #495057; border: 1px solid #e9ecef; }
    .status-accepted { background: #e8f5e9; color: #2e7d32; border: 1px solid #c8e6c9; }
    .status-in_delivery { background: #fff3cd; color: #8f5a0a; border: 1px solid #ffe8a1; }
    .status-delivered { background: #e6f4ff; color: #0b6bcf; border: 1px solid #cfe3ff; }
    .status-cancelled { background: #fdecea; color: #b23c17; border: 1px solid #f7d7d2; }
    .status-paid { background: #e9f7ef; color: #1e8549; border: 1px solid #d1e9d8; }

    .order-meta {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.35rem 0.75rem;
      border-radius: 999px;
      background: #f6f8fb;
      color: #495057;
      border: 1px solid #e9ecef;
      font-weight: 600;
    }

    .order-items {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 0.75rem;
    }

    .order-item {
      background: #f8f9fa;
      border: 1px dashed #e3e6ea;
      border-radius: 12px;
      padding: 0.85rem 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
    }

    .order-item strong {
      display: block;
      font-weight: 700;
    }

    .order-item small {
      color: #6c757d;
    }

    .order-hero {
      background: radial-gradient(circle at 20% 20%, rgba(255, 255, 255, 0.9) 0, rgba(255, 255, 255, 0.2) 35%, rgba(255, 255, 255, 0) 50%), linear-gradient(120deg, #0f0f0f, #2a2a2a);
      border-radius: 22px;
      padding: 1.75rem;
      color: #fff;
      border: 1px solid rgba(255, 255, 255, 0.08);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.18);
    }
  </style>

  <div class="order-hero mb-4">
    <div class="d-flex align-items-center flex-wrap gap-3">
      <div class="order-pill bg-white text-dark shadow-sm">
        <i class="bi bi-bag-check-fill"></i>
      </div>
      <div>
        <h2 class="fw-bold mb-1">Мои заказы товаров</h2>
        <p class="mb-0 text-light opacity-75">Отслеживайте статус заказов, адрес доставки и детали товаров в одном месте.</p>
      </div>
      {% if orders %}
        <div class="ms-auto d-flex flex-wrap gap-2">
          <span class="order-meta"><i class="bi bi-clock-history"></i> Недавние заказы: {{ orders|length }}</span>
        </div>
      {% endif %}
    </div>
  </div>

  {% if orders %}
    <div class="row g-4">
      {% for order in orders %}
        <div class="col-12">
          <div class="order-card shadow-sm h-100">
            <div class="card-body p-4">
              <div class="d-flex justify-content-between align-items-start flex-wrap gap-3 mb-3">
                <div class="d-flex align-items-start gap-3">
                  <div class="order-pill">#{{ order.id }}</div>
                  <div>
                  <div class="fw-semibold text-dark fs-5">Заказ №{{ order.id }}</div>
                  <div class="text-muted small d-flex align-items-center gap-2">
                    <i class="bi bi-calendar-week"></i>
                    {{ order.created_at|date:"d.m.Y H:i" }}
                  </div>
                    <div class="d-flex flex-wrap gap-2 mt-2">
                      <span class="status-badge status-{{ order.status }}">{{ order.get_status_display }}</span>
                      <span class="status-badge bg-white border text-dark">
                        <i class="bi bi-wallet2 me-1"></i>{{ order.get_payment_method_display }}
                      </span>
                      {% if order.is_pickup %}
                        <span class="status-badge bg-secondary text-white border-0"><i class="bi bi-shop me-1"></i>Самовывоз</span>
                      {% endif %}
                      {% if order.status != 'cancelled' and order.status != 'delivered' %}
                        <form method="post" action="{% url 'cancel_product_order' order.id %}">
                          {% csrf_token %}
                          <button type="submit" class="btn btn-outline-danger btn-sm ms-1 d-inline-flex align-items-center gap-1">
                            <i class="bi bi-x-circle"></i><span>Отменить</span>
                          </button>
                        </form>
                      {% endif %}
                    </div>
                  </div>
                </div>
                <div class="text-end">
                  <div class="text-muted small">Итого</div>
                  <div class="h4 fw-bold mb-1">{{ order.total_amount|intcomma }} сум</div>
                  {% if not order.is_pickup %}
                    <div class="text-muted small d-flex align-items-center justify-content-end gap-2">
                      <i class="bi bi-geo-alt"></i> {{ order.address|default:"—" }}
                    </div>
                  {% endif %}
                </div>
              </div>

              <div class="order-items mt-3">
                {% for item in order.items.all %}
                  <div class="order-item">
                    <div>
                      <strong>{{ item.product_name }}</strong>
                      <small>{{ item.unit_price|intcomma }} сум × {{ item.quantity }} шт.</small>
                    </div>
                    <div class="fw-semibold text-dark">{{ item.get_total|intcomma }} сум</div>
                  </div>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="text-center bg-white rounded-4 border shadow-sm p-5">
      <div class="display-6 text-muted mb-3"><i class="bi bi-box-seam"></i></div>
      <h5 class="fw-semibold mb-2">Заказов пока нет</h5>
      <p class="text-muted mb-0">Соберите корзину любимых товаров и оформите свой первый заказ.</p>
    </div>
  {% endif %}
</div>
{% endblock %}
