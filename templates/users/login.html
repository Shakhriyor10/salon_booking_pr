{% extends 'base3.html' %}
{% load widget_tweaks %}
{% block title %}–í—Ö–æ–¥{% endblock %}
{% block content %}
<style>
  .btn-custom {
    background-color: #212529;
    color: white;
  }

  .btn-custom:hover {
    background-color: #212529;
    color: white;
  }
</style>

<div class="container" style="max-width: 400px;">
  <div class="card shadow-sm mt-5 border-0">
    <div class="card-header text-white text-center" style="background-color: #212529;">
      <h4 class="mb-0">üîê –í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</h4>
    </div>
    <div class="card-body">
      <form method="post">
  {% csrf_token %}
  <input type="hidden" name="next" value="{{ next_url }}">
  {% for field in form %}
    <div class="mb-3">
      <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label>
      {{ field|add_class:"form-control" }}
      {% if field.errors %}
        <div class="text-danger small">{{ field.errors|striptags }}</div>
      {% endif %}
    </div>
  {% endfor %}

  <button type="submit" class="btn btn-custom w-100">–í–æ–π—Ç–∏</button>
</form>
    </div>
    {% if telegram_login_enabled %}
    <div class="card-body border-top">
      <p class="text-center text-muted mb-2">–ò–ª–∏ –≤–æ–π–¥–∏—Ç–µ —á–µ—Ä–µ–∑ Telegram</p>
      <div class="d-flex justify-content-center">
        <script async src="https://telegram.org/js/telegram-widget.js?21"
                data-telegram-login="{{ telegram_bot_name }}"
                data-size="large"
                data-userpic="false"
                data-request-access="write"
                data-onauth="onTelegramAuth"></script>
      </div>
      <div id="telegram-login-message" class="text-danger small mt-2 text-center" style="display: none;"></div>
    </div>
    <script>
      function onTelegramAuth(user) {
        const payload = Object.assign({ next: "{{ telegram_redirect_url|escapejs }}" }, user);
        fetch("{% url 'telegram_login' %}", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          credentials: "same-origin",
          body: JSON.stringify(payload)
        })
        .then(function(response) { return response.json(); })
        .then(function(data) {
          if (data.ok) {
            window.location.href = data.redirect_url || "{{ telegram_redirect_url }}";
          } else {
            showTelegramError(data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –≤—Ö–æ–¥ —á–µ—Ä–µ–∑ Telegram.');
          }
        })
        .catch(function() {
          showTelegramError('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ Telegram.');
        });
      }

      function showTelegramError(message) {
        var container = document.getElementById('telegram-login-message');
        if (!container) {
          return;
        }
        container.textContent = message;
        container.style.display = 'block';
      }
    </script>
    {% elif telegram_bot_name %}
    <div class="card-body border-top">
      <p class="text-center text-muted mb-0">
        –¢–µ–ª–µ–≥—Ä–∞–º-–±–æ—Ç <strong>@{{ telegram_bot_name }}</strong> –Ω–∞—Å—Ç—Ä–æ–µ–Ω, –Ω–æ —Ç–æ–∫–µ–Ω –Ω–µ —É–∫–∞–∑–∞–Ω.
        –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏.
      </p>
    </div>
    {% else %}
    <div class="card-body border-top">
      <p class="text-center text-muted mb-0">
        –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ Telegram –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞ –ø–æ—Å–ª–µ —É–∫–∞–∑–∞–Ω–∏—è –∏–º–µ–Ω–∏ –±–æ—Ç–∞ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö.
      </p>
    </div>
    {% endif %}
    <div class="card-footer text-center bg-light">
      <p class="mb-0">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <a href="{% url 'register' %}">–°–æ–∑–¥–∞—Ç—å</a></p>
    </div>
  </div>
</div>

{% endblock %}
