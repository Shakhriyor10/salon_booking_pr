{% extends 'base3.html' %}
{% block title %}–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è{% endblock %}
{% block content %}
{% load form_tags %}
<style>
  .btn-custom {
    background-color: #212529;
    color: white;
  }

  .btn-custom:hover {
    background-color: #212529;
    color: white;
  }
</style>
<div class="container" style="max-width: 400px;">
  <div class="card shadow-sm mt-5 border-0">
    <div class="card-header text-white text-center" style="background-color: #212529;">
      <h4 class="mb-0">üìù –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h4>
    </div>

    <div class="card-body bg-light">
      <form method="post">
        {% csrf_token %}
        {{ form.non_field_errors }}
        <input type="hidden" name="next" value="{{ next_url }}">

        <div class="mb-3">
          {{ form.username.label_tag }}
          {{ form.username|add_class:"form-control" }}
        </div>

        <div class="mb-3">
          {{ form.first_name.label_tag }}
          {{ form.first_name|add_class:"form-control" }}
        </div>


          <div class="mb-3">
              <label for="id_phone" class="form-label">–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞</label>
              <div class="input-group">
                  <span class="input-group-text">+998</span>
                  <input type="tel" name="phone" id="id_phone"
                         class="form-control"
                         inputmode="numeric"
                         placeholder="93-123-45-67"
                         pattern="^\d{2}-\d{3}-\d{2}-\d{2}$"
                         title="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –≤ —Ñ–æ—Ä–º–∞—Ç–µ 93-123-45-67"
                         data-uzbek-phone-input
                         required>
              </div>
              <div class="form-text">–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –±–µ–∑ –∫–æ–¥–∞ —Å—Ç—Ä–∞–Ω—ã ‚Äî –æ–Ω —É–∫–∞–∑–∞–Ω —Å–ª–µ–≤–∞.</div>
          </div>

        <div class="mb-3">
          {{ form.password1.label_tag }}
          {{ form.password1|add_class:"form-control" }}
        </div>

        <div class="mb-4">
          {{ form.password2.label_tag }}
          {{ form.password2|add_class:"form-control" }}
        </div>

        <button type="submit" class="btn btn-custom w-100">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
      </form>
      {% if telegram_bot_name %}
      <div class="mt-4 text-center">
        <p class="text-muted mb-2">–ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ Telegram</p>
        <div class="d-flex justify-content-center">
          <script async src="https://telegram.org/js/telegram-widget.js?21"
                  data-telegram-login="{{ telegram_bot_name }}"
                  data-size="large"
                  data-userpic="false"
                  data-request-access="write"
                  data-onauth="onTelegramAuth"></script>
        </div>
        <div id="telegram-login-message" class="text-danger small mt-2" style="display: none;"></div>
      </div>
      <script>
        function onTelegramAuth(user) {
          const payload = Object.assign({ next: "{{ telegram_redirect_url|escapejs }}" }, user);
          fetch("{% url 'telegram_login' %}", {
            method: "POST",
            headers: {
              "Content-Type": "application/json"
            },
            credentials: "same-origin",
            body: JSON.stringify(payload)
          })
          .then(function(response) { return response.json(); })
          .then(function(data) {
            if (data.ok) {
              window.location.href = data.redirect_url || "{{ telegram_redirect_url }}";
            } else {
              showTelegramError(data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –≤—Ö–æ–¥ —á–µ—Ä–µ–∑ Telegram.');
            }
          })
          .catch(function() {
            showTelegramError('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ Telegram.');
          });
        }

        function showTelegramError(message) {
          var container = document.getElementById('telegram-login-message');
          if (!container) {
            return;
          }
          container.textContent = message;
          container.style.display = 'block';
        }
      </script>
      {% endif %}
    </div>

    <div class="card-footer text-center bg-light">
      <p class="mb-0">–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? <a href="{% url 'login' %}">–í–æ–π—Ç–∏</a></p>
    </div>
  </div>
</div>
{% endblock %}