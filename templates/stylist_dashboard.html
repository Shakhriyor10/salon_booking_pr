{% extends 'base3.html' %}
{% load static %}
{% load form_tags %}
{% block content %}
<div class="container mt-4">
  <h2>üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, {{ user.get_full_name|default:user.username }}</h2>
 <h4 class="mt-3 mb-2">
  üí∞ –ö–∞—Å—Å–∞ –Ω–∞ {{ today|date:"d.m.Y" }}: <span class="badge bg-success">{{ total_cash }} —Å—É–º</span>
</h4>
  {% for date, appointments_on_date in grouped_appointments.items %}
    <h5 class="mt-4">{{ date }}</h5>

    <div class="table-responsive">
      <table class="table table-striped table-bordered align-middle">
        <thead class="table-dark">
          <tr>
            <th>–ö–ª–∏–µ–Ω—Ç</th>
            <th>–£—Å–ª—É–≥–∞</th>
            <th>–í—Ä–µ–º—è</th>
            <th>–°—Ç–∞—Ç—É—Å</th>
            <th>–¶–µ–Ω–∞</th>
            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
          </tr>
        </thead>
        <tbody>
          {% for a in appointments_on_date %}
            <tr>
              <td>
                {% if a.customer %}
                  {{ a.customer.first_name|default:a.customer.username }}
                  {% if a.customer.profile.phone %}
                    ({{ a.customer.profile.phone }})
                  {% endif %}
                {% else %}
                  {{ a.guest_name }} ({{ a.guest_phone }})
                {% endif %}
              </td>
              <td>
                {% for service in a.services.all %}
                {{ service.stylist_service.salon_service.service.name }}{% if not forloop.last %}, {% endif %}
                {% empty %}
                –ù–µ—Ç —É—Å–ª—É–≥
                {% endfor %}
              </td>
              <td>{{ a.start_time|date:"H:i" }}</td>
              <td>{{ a.get_status_display }}</td>
              <td>
  {{ a.services.all|sum_prices }} —Å—É–º
</td>
              <td>
                {% if a.status == 'P' %}
                  <form method="post" action="{% url 'appointment_update_status' a.id %}" style="display:inline;">
                    {% csrf_token %}
                    <input type="hidden" name="status" value="C">
                    <button type="submit" class="btn btn-success btn-sm mb-1">‚úÖ –ü—Ä–∏–Ω—è—Ç—å</button>
                  </form>
                  <form method="post" action="{% url 'appointment_update_status' a.id %}" style="display:inline;"
                        onsubmit="return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–ø–∏—Å—å?');">
                      {% csrf_token %}
                      <input type="hidden" name="status" value="DELETE">
                      <button type="submit" class="btn btn-danger btn-sm mb-1">‚ùå –û—Ç–º–µ–Ω–∏—Ç—å</button>
                  </form>
                {% elif a.status == 'C' %}
                  <form method="post" action="{% url 'appointment_update_status' a.id %}" style="display:inline;">
                    {% csrf_token %}
                    <input type="hidden" name="status" value="D">
                  <button type="submit" class="btn btn-primary btn-sm">‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ</button>
                  </form>
                  <form method="post" action="{% url 'appointment_update_status' a.id %}" style="display:inline;"
                        onsubmit="return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–ø–∏—Å—å?');">
                      {% csrf_token %}
                      <input type="hidden" name="status" value="DELETE">
                      <button type="submit" class="btn btn-danger btn-sm mb-1">‚ùå –û—Ç–º–µ–Ω–∏—Ç—å</button>
                  </form>
                {% endif %}
              </td>
            </tr>
          {% empty %}
            <tr><td colspan="6">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% empty %}
    <p>–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π.</p>
  {% endfor %}
</div>
{% endblock %}